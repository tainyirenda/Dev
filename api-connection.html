<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

   <!-- Favicon -->
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <title>Afro Ubuntu TradeNet — Sign In</title>
  <meta name="description" content="Sign in to Afro Ubuntu TradeNet" />
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

   <script type="text/javascript">
  // Fire a change event in the older "HTMLEvents" style Google expects
  function fireGoogleTranslateEvent(el, eventName) {
    try {
      if (document.createEvent) {
        var event = document.createEvent("HTMLEvents");
        event.initEvent(eventName, true, true);
        el.dispatchEvent(event);
      } else if (document.createEventObject) { // IE fallback
        var event = document.createEventObject();
        el.fireEvent("on" + eventName, event);
      } else {
        el.dispatchEvent(new Event(eventName));
      }
    } catch (e) {
      el.dispatchEvent(new Event(eventName));
    }
  }

  function setGoogleTransCookie(lang) {
    // page language is 'en', so cookie must be /en/<target>
    var value = "/en/" + lang;
    var domain = window.location.hostname;
    document.cookie = "googtrans=" + value + ";path=/;";
    document.cookie = "googtrans=" + value + ";path=/;domain=" + domain + ";";
  }

  // Global helper used by the custom language menu
  function setLanguage(lang) {
    function applyLang() {
      const combo = document.querySelector(".goog-te-combo");
      if (!combo) return false;
      combo.value = lang;
      fireGoogleTranslateEvent(combo, "change");
      try { localStorage.setItem("selectedLang", lang); } catch (e) {}
      return true;
    }
    if (applyLang()) return;
    const observer = new MutationObserver(() => {
      if (applyLang()) observer.disconnect();
    });
    observer.observe(document.body, { childList: true, subtree: true });
    setGoogleTransCookie(lang);
    setTimeout(function () { window.location.reload(); }, 300);
  }

  function googleTranslateElementInit() {
    new google.translate.TranslateElement(
      {
        pageLanguage: 'en',
        // UPDATED: Added 'ha' (Hausa), 'pcm' (Pidgin), 'nd' (Ndebele)
        includedLanguages: 'en,sw,sn,ny,yo,af,xh,zu,fr,ha,pcm,nd', 
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE
      },
      'google_translate_element'
    );

    const observer = new MutationObserver(function (mutations, obs) {
      const combo = document.querySelector('.goog-te-combo');
      if (combo) {
        const savedLang = localStorage.getItem('selectedLang');
        if (savedLang) {
          combo.value = savedLang;
          fireGoogleTranslateEvent(combo, 'change');
        }
        combo.addEventListener('change', function () {
          try { localStorage.setItem('selectedLang', this.value); } catch (e) {}
        });
        obs.disconnect();
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
  }
</script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
  
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-N6PKL5BZQF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-N6PKL5BZQF');
  </script>
  
  <style>
    :root{
      /* Brand palette */
      --orange-600:#ea580c;
      --orange-700:#c2410c;
      --green-600:#16a34a;
      --green-700:#15803d;
    }
    html,body{height:100%}
    body{
      background:
        radial-gradient(900px 600px at 10% 0%, rgba(234,88,12,0.12), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(22,163,74,0.18), transparent 60%),
        linear-gradient(135deg, #0d1b14 0%, #0b1511 40%, #0d1b14 100%);
      color:#fff;
    }
    .glass{backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px)}
    .focus-ring:focus{outline:none;box-shadow:0 0 0 3px rgba(234,88,12,0.35)}
    .btn-gradient{background:linear-gradient(135deg,var(--orange-600),var(--green-600));}
    .btn-gradient:hover{background:linear-gradient(135deg,var(--orange-700),var(--green-700));}
    .tab{padding:.5rem .75rem;border-radius:.5rem;font-size:.875rem;font-weight:600;color:rgba(255,255,255,.85)}
    .tab-active{background:rgba(255,255,255,.15);color:#fff}

    #google_translate_element, .goog-te-gadget, .goog-te-gadget > div, .goog-te-combo { display: none !important; }
    #lang-btn.tab-like { padding-inline: 0.75rem; padding-block: 0.4rem; font-size: 0.75rem; }
  </style>
</head>
<body class="min-h-full">
  <!-- Top nav -->
  <header class="mx-auto max-w-7xl px-6 pt-6">
    <nav class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-[color:var(--orange-600)] to-[color:var(--green-600)] grid place-items-center shadow">
          <i data-lucide="globe" class="w-5 h-5"></i>
        </div>
        <span class="text-lg font-semibold">Afro Ubuntu TradeNet</span>
      </div>
      <ul class="flex items-center gap-8 text-sm text-white/85">
        <li><a class="hover:text-white" href="https://www.afroubuntutrade.co.uk/index.html">Home</a></li>
        <li><a class="hover:text-white" href="#" data-modal-target="servicesModal">Services</a></li>
        <!-- Language menu -->
          <div id="lang-menu-wrapper" class="relative inline-block text-left ml-4">
           <button id="lang-btn" class="tab tab-active flex items-center gap-1 px-3 py-1.5 rounded-xl text-xs">
  <i data-lucide="globe" class="h-4 w-4"></i>
  <span>Language</span>
</button>

            <div
  id="lang-menu"
  class="absolute right-0 mt-2 w-44 rounded-xl border border-white/15 bg-[#050b09]/95 backdrop-blur-xl shadow-xl hidden z-20 max-h-60 overflow-y-auto"
>
  <button data-lang="en" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">English</button>
  <button data-lang="sw" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Swahili</button>
  <button data-lang="fr" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">French</button>
  
  <button data-lang="ha" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Hausa</button>
  <button data-lang="pcm" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Pidgin</button>
  <button data-lang="nd" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Ndebele</button>
  
  <button data-lang="yo" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Yoruba</button>
  <button data-lang="zu" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Zulu</button>
  <button data-lang="xh" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Xhosa</button>
  <button data-lang="sn" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Shona</button>
  <button data-lang="ny" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Nyanja</button>
  <button data-lang="af" class="block w-full text-left px-4 py-2.5 text-xs text-white/80 hover:bg-white/10">Afrikaans</button>
</div>
          </div>
          <div id="google_translate_element" class="hidden"></div>
      </ul>
    </nav>
  </header>

  <!-- Main card -->
  <main class="mx-auto max-w-7xl px-6 py-10">
    <section class="glass rounded-3xl border border-white/10 bg-white/5 shadow-2xl overflow-hidden">
      <div class="grid grid-cols-1 md:grid-cols-2">
        <!-- Left / Welcome -->
        <div class="relative p-10 md:p-14">
          <div class="absolute inset-0 opacity-20 pointer-events-none bg-gradient-to-br from-[color:var(--orange-600)] via-[color:var(--green-600)] to-[color:var(--green-600)]"></div>
          <div class="relative">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl bg-gradient-to-tr from-[color:var(--orange-600)] to-[color:var(--green-600)] grid place-items-center shadow-lg">
                <i data-lucide="globe" class="w-6 h-6"></i>
              </div>
              <h2 class="text-2xl font-bold">Welcome!</h2>
            </div>
            <p class="mt-5 max-w-md text-white/85 text-[15px] leading-relaxed">
              Welcome <span id="welcomeName">Member</span> - access analytics, automate decisions, and connect with partners across the Afro Ubuntu TradeNet ecosystem.
            </p>
            <p class="mt-4 text-[15px] text-white/75 leading-relaxed max-w-lg">
              Sign in on the right. If you don’t have an account yet, you can create one in seconds.
            </p>
            <div class="mt-8 flex items-center gap-4 text-white/80">
              <a href="https://www.linkedin.com/company/afro-ubuntu-tradenet" target="_blank" rel="noopener noreferrer"><i data-lucide="linkedin" class="w-5 h-5 hover:opacity-90"></i></a>
              <a href="https://x.com/afroubuntutrade" target="_blank" rel="noopener noreferrer"><i data-lucide="twitter" class="w-5 h-5 hover:opacity-90"></i></a>
              <a href="mailto:info@afroubuntutrade.co.uk"><i data-lucide="mail" class="w-5 h-5 hover:opacity-90"></i></a>
            </div>
            <footer class="mt-10 text-sm text-white/70">© <span id="year"></span> Afro Ubuntu TradeNet</footer>
          </div>
        </div>
        
        <!-- Right / Sign in -->
        <div class="p-10 md:p-14 bg-gradient-to-bl from-white/5 to-white/0">
          <h3 class="text-2xl font-bold text-center">Sign In</h3>

          <!-- Tabs -->
          <div class="mt-6 grid grid-cols-2 bg-white/10 rounded-xl p-1">
            <button id="tabEmail" type="button" class="tab tab-active">Email</button>
            <button id="tabPhone" type="button" class="tab">Phone</button>
          </div>

          <!-- Alert -->
          <div id="alertBox" class="hidden mt-6 rounded-xl border border-red-300/40 bg-red-500/10 text-red-200 px-4 py-3 text-sm">
            <span id="alertText">Error</span>
          </div>

          <!-- Email/Password form -->
          <form id="loginForm" class="mt-6 space-y-5" novalidate>
            <div>
              <label for="emailInput" class="block text-sm text-white/85 mb-1">Email</label>
              <div class="relative">
                <input id="emailInput" type="email" autocomplete="email" required placeholder="you@example.com" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-3 text-white placeholder-white/60" />
                <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
              </div>
            </div>

            <div>
              <label for="passwordInput" class="block text-sm text-white/85 mb-1">Password</label>
              <div class="relative">
                <input id="passwordInput" type="password" autocomplete="current-password" required placeholder="••••••••" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-3 text-white placeholder-white/60" />
                <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
                <button id="togglePassword" type="button" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg hover:bg-white/10" aria-label="Show password">
                  <span id="pwdIcon"></span>
                </button>
              </div>
            </div>

            <div class="flex items-center justify-between text-sm text-white/85">
              <label class="inline-flex items-center gap-2 select-none">
                <input type="checkbox" class="rounded border-white/20 bg-transparent" />
                Remember me
              </label>
              <a href="forgot-password.html" id="forgotLink" class="hover:underline text-white">Forgot password?</a>
            </div>

            <button id="loginBtn" type="submit" class="w-full rounded-xl btn-gradient px-4 py-3 font-medium text-white shadow-lg hover:opacity-95 focus-ring transition-all">
              Sign In
            </button>
          </form>

          <!-- Phone/Code form -->
          <form id="otpForm" class="mt-6 space-y-5 hidden" novalidate>
            <div>
              <label for="phoneInput" class="block text-sm text-white/85 mb-1">Phone number</label>
              <div class="relative">
                <input id="phoneInput" type="tel" autocomplete="tel" placeholder="e.g. +44 7123 456789" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-3 text-white placeholder-white/60" />
                <i data-lucide="phone" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
              </div>
            </div>

            <div>
              <label for="codeInput" class="block text-sm text-white/85 mb-1">Verification code</label>
              <div class="relative">
                <input id="codeInput" type="text" inputmode="numeric" pattern="[0-9]{4,8}" placeholder="Enter code" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-3 text-white placeholder-white/60" />
                <i data-lucide="hash" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
              </div>
              <button id="sendCodeBtn" type="button" class="mt-2 rounded-xl border border-white/20 px-4 py-2 hover:bg-white/10 focus-ring transition-all">Send code</button>
            </div>

            <button id="otpLoginBtn" type="submit" class="w-full rounded-xl btn-gradient px-4 py-3 font-medium text-white shadow-lg hover:opacity-95 focus-ring transition-all">Sign In</button>

            <a
              id="whatsappLink"
              href="https://wa.me/+447888867533?text=Hi, I want to join Afro Ubuntu TradeNet"
              target="_blank"
              rel="noopener noreferrer"
              class="group inline-flex w-full items-center justify-center gap-2 rounded-xl border border-white/20 px-4 py-3 text-white hover:bg-white/10 focus-ring"
            >
              <i data-lucide="smartphone" class="h-5 w-5 shrink-0 align-middle group-hover:scale-110 transition-transform"></i>
              <span class="leading-none">Continue with WhatsApp</span>
            </a>
          </form>

          <p class="mt-4 text-center text-sm text-white/85">Don't have an account?
            <a href="#" data-modal-target="signUpModal" class="font-semibold text-white hover:underline">Sign up</a>
          </p>

          <div class="mt-6 text-xs text-white/70 flex flex-wrap items-center gap-3 justify-center">
            <a href="#" class="hover:underline" data-modal-target="privacyModal">Privacy Policy</a>
            <span class="opacity-40">•</span>
            <a href="#" class="hover:underline" data-modal-target="termsModal">Terms of Service</a>
            <span class="opacity-40">•</span>
            <a href="#" class="hover:underline" data-modal-target="ethicalModal">Ethical Data &amp; AI Use</a>
          </div>

        </div>
      </div>
    </section>
  </main>

  <!-- Sign Up Modal -->
  <div id="signUpModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60" data-modal-overlay>
    <div role="dialog" aria-modal="true" class="glass w-full max-w-lg rounded-2xl border border-white/10 bg-white/10 p-6 text-white">
      <div class="flex items-center justify-between">
        <h4 class="text-xl font-semibold">Create your account</h4>
        <button data-modal-close class="p-2 rounded-lg hover:bg-white/10" aria-label="Close">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <div id="su_alert" class="hidden mt-4 p-3 rounded-xl border text-sm"></div>

      <form id="signUpForm" class="mt-4 space-y-4">
        <div>
          <label class="block text-sm text-white/85 mb-1" for="su_name">Full name</label>
          <input id="su_name" type="text" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-white placeholder-white/60" placeholder="Jane Doe" required />
        </div>
        <div>
          <label class="block text-sm text-white/85 mb-1" for="su_email">Email</label>
          <input id="su_email" type="email" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-3 py-2 text-white placeholder-white/60" placeholder="you@example.com" required />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-white/85 mb-1" for="su_password">Password</label>
            <div class="relative">
              <input id="su_password" type="password" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-2 text-white placeholder-white/60" placeholder="At least 8 characters" required />
              <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
            </div>
          </div>
          <div>
            <label class="block text-sm text-white/85 mb-1" for="su_password2">Confirm</label>
            <div class="relative">
              <input id="su_password2" type="password" class="focus-ring w-full rounded-xl border border-white/10 bg-white/10 px-10 py-2 text-white placeholder-white/60" placeholder="Repeat password" required />
              <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/70"></i>
            </div>
          </div>
        </div>
        <label class="mt-2 flex items-start gap-3 text-sm text-white/85">
          <input id="su_agree" type="checkbox" class="mt-1 rounded border-white/20 bg-transparent" />
          <span>I agree to the Terms, Privacy Policy, and the use of my data.</span>
        </label>
        <div class="flex items-center gap-3 pt-2">
          <button id="su_submit" type="submit" class="rounded-xl btn-gradient px-4 py-2 font-medium text-white hover:opacity-95 focus-ring">Create account</button>
          <button type="button" data-modal-close class="px-4 py-2 rounded-xl border border-white/20 hover:bg-white/10 focus-ring">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Services Modal -->
  <div id="servicesModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60" data-modal-overlay>
    <div role="dialog" aria-modal="true" class="glass w-full max-w-5xl rounded-2xl border border-white/10 bg-white p-6 text-gray-900 overflow-y-auto max-h-[85vh]">
      <div class="flex items-center justify-between mb-2">
        <h4 class="text-xl font-semibold">Services & Pricing</h4>
        <button data-modal-close class="p-2 rounded-lg hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <p class="text-gray-600 text-sm mb-6">All plans include WhatsApp onboarding & secure data.</p>
      <!-- (Content simplified for brevity) -->
      <div class="text-center p-10 bg-gray-50 rounded-lg">
          <h3 class="text-lg font-bold">Standard Pricing Tiers Loaded</h3>
          <p class="text-sm text-gray-500">Retailers, FMCG, NGOs, Fintechs</p>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="privacyModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60" data-modal-overlay>
    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
       <h2 class="text-lg font-semibold mb-2">Privacy Policy</h2>
       <div class="border rounded-lg overflow-hidden h-64"><iframe src="privacy-policy.html" class="w-full h-full"></iframe></div>
       <button class="btn-outline mt-4 text-xs" data-modal-close>Close</button>
    </div>
  </div>
  <div id="termsModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60" data-modal-overlay>
    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
       <h2 class="text-lg font-semibold mb-2">Terms of Service</h2>
       <div class="border rounded-lg overflow-hidden h-64"><iframe src="terms-of-service.html" class="w-full h-full"></iframe></div>
       <button class="btn-outline mt-4 text-xs" data-modal-close>Close</button>
    </div>
  </div>
  <div id="ethicalModal" class="hidden fixed inset-0 z-50 grid place-items-center bg-black/60" data-modal-overlay>
    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
       <h2 class="text-lg font-semibold mb-2">Ethical Data & AI</h2>
       <div class="border rounded-lg overflow-hidden h-64"><iframe src="ethical-ai-policy.html" class="w-full h-full"></iframe></div>
       <button class="btn-outline mt-4 text-xs" data-modal-close>Close</button>
    </div>
  </div>

  <script>
  // ===== Brand & routes =====
  const API_BASE = 'https://afroauth-api-g7cqa9cvc4amhqh2.uksouth-01.azurewebsites.net';
  const params = new URLSearchParams(location.search);
  const CONTINUE_URL = params.get('continue') || 'https://www.afroubuntutrade.co.uk/api-connection.min.html';
  
  // UPDATED: v1 paths
  const OTP_REQUEST_PATH = '/api/v1/auth/request-otp';
  const OTP_VERIFY_PATH  = '/api/v1/auth/verify-otp';

  // ===== Helpers =====
  function setBusy(btn, label) {
    if (!btn) return;
    btn.disabled = true;
    btn.classList.add('opacity-70', 'cursor-not-allowed');
    btn.dataset.__orig = btn.innerHTML; // Save original HTML
    if (label) btn.innerHTML = `<i data-lucide="loader-2" class="inline w-4 h-4 animate-spin mr-2"></i>${label}`;
    lucide.createIcons();
  }
  function clearBusy(btn) {
    if (!btn) return;
    btn.disabled = false;
    btn.classList.remove('opacity-70', 'cursor-not-allowed');
    if (btn.dataset.__orig) btn.innerHTML = btn.dataset.__orig;
    lucide.createIcons();
  }
  async function api(path, body, method = 'POST') {
    const res = await fetch(`${API_BASE}${path}`, {
      method,
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: method === 'GET' ? null : JSON.stringify(body || {})
    });
    let data = null; try { data = await res.json(); } catch(e) {}
    if (!res.ok) throw new Error((data && (data.error || data.message)) || `Request failed (${res.status})`);
    return data;
  }
  function isPhone(x){ return /^[+0-9()\\-\\s]{7,}$/.test((x||'').trim()); }

  // ===== Icons & year =====
  document.addEventListener('DOMContentLoaded', () => {
    try { window.lucide && window.lucide.createIcons(); } catch {}
    const y = document.getElementById('year'); if (y) y.textContent = new Date().getFullYear();
  });

  // ===== Toggle UI Logic =====
  document.addEventListener('DOMContentLoaded', () => {
    // Password
    function attachPwdToggle(inputId, btnId){
        const input = document.getElementById(inputId), btn = document.getElementById(btnId);
        if(input && btn) btn.addEventListener('click', () => input.type = input.type==='password'?'text':'password');
    }
    attachPwdToggle('passwordInput','togglePassword');
    attachPwdToggle('su_password','toggleSuPassword');

    // Tabs
    const tEmail = document.getElementById('tabEmail'), tPhone = document.getElementById('tabPhone');
    const fEmail = document.getElementById('loginForm'), fPhone = document.getElementById('otpForm');
    if(tEmail && tPhone){
        tEmail.addEventListener('click', ()=>{ tEmail.classList.add('tab-active'); tPhone.classList.remove('tab-active'); fEmail.classList.remove('hidden'); fPhone.classList.add('hidden'); });
        tPhone.addEventListener('click', ()=>{ tPhone.classList.add('tab-active'); tEmail.classList.remove('tab-active'); fPhone.classList.remove('hidden'); fEmail.classList.add('hidden'); });
    }

    // Language
    const lBtn = document.getElementById('lang-btn'), lMenu = document.getElementById('lang-menu');
    if(lBtn && lMenu){
        lBtn.addEventListener('click', (e)=>{ e.stopPropagation(); lMenu.classList.toggle('hidden'); });
        document.addEventListener('click', (e)=>{ if(!lBtn.contains(e.target)) lMenu.classList.add('hidden'); });
    }
  });

  // ===== Email login =====
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('loginForm');
    const alertBox = document.getElementById('alertBox');
    const alertText = document.getElementById('alertText');
    const loginBtn = document.getElementById('loginBtn');
    
    function showError(msg){ if(alertText) alertText.textContent = msg; if(alertBox) alertBox.classList.remove('hidden'); }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertBox && alertBox.classList.add('hidden');
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value;
        
        setBusy(loginBtn, 'Signing in...'); // <--- ANIMATION
        
        try {
          await api('/api/v1/login', { email, password });
          location.href = CONTINUE_URL;
        } catch (err) {
          showError(err.message || 'Invalid email or password.');
        } finally { 
          clearBusy(loginBtn); 
        }
      });
    }
  });

  // ===== Phone + OTP login =====
  document.addEventListener('DOMContentLoaded', () => {
    const alertBox = document.getElementById('alertBox');
    const alertText = document.getElementById('alertText');
    const phoneInput = document.getElementById('phoneInput');
    const codeInput = document.getElementById('codeInput');
    const sendBtn = document.getElementById('sendCodeBtn');
    const loginBtn = document.getElementById('otpLoginBtn');

    function showError(msg){ if(alertText) alertText.textContent = msg; if(alertBox) alertBox.classList.remove('hidden'); }

    document.getElementById('sendCodeBtn')?.addEventListener('click', async () => {
      const phone = phoneInput.value.trim();
      if (!isPhone(phone)) return showError('Enter valid phone number.');
      
      setBusy(sendBtn, 'Sending...'); // <--- ANIMATION
      try{
        await api(OTP_REQUEST_PATH, { phone });
        alertBox?.classList.add('hidden');
        alert("Code sent to WhatsApp!");
        codeInput.focus();
      }catch(err){ showError(err.message); }
      finally{ clearBusy(sendBtn); }
    });

    document.getElementById('otpForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const phone = phoneInput.value.trim();
      const code = codeInput.value.trim();
      
      setBusy(loginBtn, 'Verifying...'); // <--- ANIMATION
      try{
        await api(OTP_VERIFY_PATH, { phone, code });
        location.href = CONTINUE_URL;
      }catch(err){ showError(err.message || 'Invalid code.'); }
      finally{ clearBusy(loginBtn); }
    });
  });

  // ===== Sign Up =====
  document.addEventListener('DOMContentLoaded', () => {
    const suForm = document.getElementById('signUpForm');
    const suAlert = document.getElementById('su_alert');
    const suSubmit = document.getElementById('su_submit');

    if (suForm) {
      suForm.addEventListener('submit', async (e) => {
        e.preventDefault(); 
        const name = document.getElementById('su_name').value;
        const email = document.getElementById('su_email').value;
        const p1 = document.getElementById('su_password').value;
        const agree = document.getElementById('su_agree').checked;
        if(!agree) return alert("Please agree to terms.");

        setBusy(suSubmit, 'Creating...'); // <--- ANIMATION
        try{
          await api('/api/v1/signup', { name, email, password: p1 });
          suAlert.classList.remove('hidden');
          suAlert.textContent = 'Account created! Check your email to verify.';
          suAlert.className = "mt-4 p-3 rounded-xl border text-sm bg-green-500/10 border-green-300/40 text-green-200";
        }catch(err){ 
            suAlert.classList.remove('hidden');
            suAlert.textContent = err.message;
            suAlert.className = "mt-4 p-3 rounded-xl border text-sm bg-red-500/10 border-red-300/40 text-red-200";
        }
        finally{ clearBusy(suSubmit); }
      });
    }
  });

  // ===== Modal Logic & Token Saver =====
  (function(){
    function openModal(id){ document.getElementById(id)?.classList.remove('hidden'); }
    function closeModal(id){ document.getElementById(id)?.classList.add('hidden'); }
    document.addEventListener('click', (e)=>{ 
        const t = e.target.closest('[data-modal-target]'); 
        if(t) openModal(t.dataset.modalTarget);
        const c = e.target.closest('[data-modal-close]');
        if(c) closeModal(c.closest('[id]').id);
        if(e.target.hasAttribute('data-modal-overlay')) closeModal(e.target.id);
    });

    const _fetch = window.fetch.bind(window);
    window.fetch = async function(resource, init={}) {
      const url = (typeof resource === 'string') ? resource : resource.url;
      const res = await _fetch(resource, init);
      // Capture Token on Login/Signup/OTP
      if (url && url.includes('/api/v1/') && (url.includes('/login') || url.includes('/signup') || url.includes('/verify-otp'))) {
          try {
              const clone = res.clone();
              const data = await clone.json();
              if (data && data.token) localStorage.setItem('token', data.token);
          } catch(e){}
      }
      return res;
    };
  })();
  </script>
</body>
</html>
