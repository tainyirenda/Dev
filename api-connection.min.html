<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <title>Afro Ubuntu • Account Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CSS / Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Chart.js for Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Translate Logic -->
  <script type="text/javascript">
  function fireGoogleTranslateEvent(el, eventName) { try { if (document.createEvent) { var event = document.createEvent("HTMLEvents"); event.initEvent(eventName, true, true); el.dispatchEvent(event); } else { el.dispatchEvent(new Event(eventName)); } } catch (e) {} }
  function setGoogleTransCookie(lang) { document.cookie = "googtrans=/en/" + lang + ";path=/;"; document.cookie = "googtrans=/en/" + lang + ";path=/;domain=" + window.location.hostname + ";"; }
  window.setLanguage = function(lang) { 
    function apply() { const c = document.querySelector(".goog-te-combo"); if (!c) return false; c.value = lang; fireGoogleTranslateEvent(c, "change"); try { localStorage.setItem("selectedLang", lang); } catch (e) {} return true; } 
    if (apply()) return; 
    const obs = new MutationObserver(() => { if (apply()) obs.disconnect(); }); 
    obs.observe(document.body, { childList: true, subtree: true }); 
    setGoogleTransCookie(lang); 
    setTimeout(() => window.location.reload(), 300); 
  };
  function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'en', includedLanguages: 'en,sw,sn,ny,yo,af,xh,zu,fr,ha,pcm,nd', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element'); }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
  
  <style>
    :root{ --au-ink:#111827; --au-stone:#6b7280; --au-line:#e5e7eb; --au-surface:#f8fafc; --au-accent:#ea580c; --au-green:#16a34a; }
    body{ font-family:Inter, sans-serif; background:var(--au-surface); color:var(--au-ink); }
    .card { background: #fff; border:1px solid var(--au-line); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    .iconwrap { width:48px; height:48px; border-radius:12px; display:grid; place-items:center; background:#f3f4f6; color:var(--au-ink); }
    .btn-outline { border:1px solid var(--au-line); border-radius:10px; padding:8px 14px; background:#fff; font-weight:500; transition:all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;}
    .btn-outline:hover { background:#f9fafb; border-color:#d1d5db; }
    .btn-primary { background: var(--au-ink); color: #fff; border-radius:10px; padding:10px 14px; font-weight:600; transition:opacity 0.2s; }
    .btn-primary:hover { opacity: 0.9; }
    .pill { padding:.2rem .6rem; border-radius:99px; font-size:.75rem; font-weight:600; }
    .link { text-decoration: underline; text-decoration-color: #d1d5db; text-underline-offset: 3px; cursor: pointer; }
    .link:hover { color: var(--au-accent); text-decoration-color: var(--au-accent); }
    
    /* View Switching Utilities */
    .view-section { display: none; animation: fadeIn 0.3s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* AI Pulse Animation */
    @keyframes pulse-orange {
      0%, 100% { color: var(--au-accent); opacity: 1; }
      50% { opacity: .6; }
    }
    .animate-ai { animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    #google_translate_element { display: none !important; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-white border-b border-[color:var(--au-line)] sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <!-- Clicking Logo returns to Hub -->
      <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('hub')">
        <div class="w-9 h-9 rounded-lg bg-[color:var(--au-ink)] grid place-items-center text-white text-[11px] font-bold">AUTN</div>
        <div class="hidden sm:block">
          <p class="text-sm font-semibold text-[color:var(--au-ink)]">Afro Ubuntu TradeNet</p>
          <p class="text-xs text-[color:var(--au-stone)]">Rooted in Africa, connected to the world</p>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <!-- Language Dropdown -->
        <div class="relative group">
           <button id="lang-btn" class="btn-outline text-xs">
             <i data-lucide="globe" class="w-3 h-3"></i> Language
           </button>
           <!-- Dropdown Menu -->
           <div id="lang-menu" class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-xl shadow-xl hidden p-1 z-50 max-h-60 overflow-y-auto">
             <button onclick="window.setLanguage('en')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">English</button>
             <button onclick="window.setLanguage('sw')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Swahili</button>
             <button onclick="window.setLanguage('fr')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">French</button>
             <button onclick="window.setLanguage('ha')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Hausa</button>
             <button onclick="window.setLanguage('pcm')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Pidgin</button>
             <button onclick="window.setLanguage('nd')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Ndebele</button>
             <button onclick="window.setLanguage('yo')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Yoruba</button>
             <button onclick="window.setLanguage('zu')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Zulu</button>
             <button onclick="window.setLanguage('xh')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Xhosa</button>
             <button onclick="window.setLanguage('sn')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Shona</button>
             <button onclick="window.setLanguage('ny')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Nyanja</button>
             <button onclick="window.setLanguage('af')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Afrikaans</button>
           </div>
        </div>
        
        <!-- Home Button -->
        <a href="index.html" class="btn-outline text-xs text-gray-700 hover:text-black">Home</a>
        
        <button id="logoutBtn" class="btn-outline text-xs text-red-600 border-red-100 hover:bg-red-50">Log out</button>
      </nav>
    </div>
    <div class="h-[3px] bg-gradient-to-r from-[color:var(--au-accent)] to-[color:var(--au-ink)]"></div>
  </header>

  <!-- Main Content Container -->
  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- ================= VIEW 1: HUB (DEFAULT) ================= -->
    <section id="view-hub" class="view-section active">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-extrabold text-[color:var(--au-ink)]">Your account</h1>
          <p class="text-[15px] text-[color:var(--au-stone)]">
            Welcome back, <span id="welcomeName" class="font-semibold text-[color:var(--au-ink)]">User</span>
          </p>
        </div>
        <span class="pill bg-green-100 text-green-700" id="status">Signed in</span>
      </div>

      <!-- Identity Card -->
      <div class="card p-4 flex items-center justify-between gap-3 mb-8">
        <div class="flex items-center gap-3">
          <div class="iconwrap"><i data-lucide="user" class="w-5 h-5"></i></div>
          <div class="min-w-0">
            <p class="text-xs text-[color:var(--au-stone)] uppercase tracking-wider font-semibold">Signed in as</p>
            <p class="text-base font-medium truncate" id="email">—</p>
          </div>
        </div>
        <button class="btn-outline text-xs" id="copyBtn">Copy</button>
      </div>

      <!-- Module Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        
        <!-- Dashboard Card -->
        <button onclick="switchView('dashboard')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-gray-200 transition-colors"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Dashboard</h3>
              <p class="mt-1 text-sm text-gray-500">Usage, APIs and performance KPIs.</p>
            </div>
          </div>
        </button>

        <!-- Insights Card -->
        <button onclick="switchView('insights')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-gray-200 transition-colors"><i data-lucide="line-chart" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Insights</h3>
              <p class="mt-1 text-sm text-gray-500">Predictive analysis, alerts & recommendations.</p>
            </div>
          </div>
        </button>

        <!-- Connect Hub -->
        <button onclick="switchView('connect')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-orange-100 group-hover:text-orange-600 transition-colors"><i data-lucide="messages-square" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Connect Hub</h3>
              <p class="mt-1 text-sm text-gray-500">Discover partners & AI-assisted matching.</p>
            </div>
          </div>
        </button>

        <!-- Verification -->
        <button onclick="switchView('verification')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-green-100 group-hover:text-green-600 transition-colors"><i data-lucide="badge-check" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Business Verification</h3>
              <p class="mt-1 text-sm text-gray-500">Confirm your business details.</p>
            </div>
          </div>
        </button>

        <!-- Track App -->
        <button onclick="switchView('track')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-gray-200 transition-colors"><i data-lucide="receipt-text" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Track Application</h3>
              <p class="mt-1 text-sm text-gray-500">See submission and review status.</p>
            </div>
          </div>
        </button>

        <!-- Billing -->
        <button onclick="switchView('billing')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors"><i data-lucide="credit-card" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Billing & Plans</h3>
              <p class="mt-1 text-sm text-gray-500">Manage plan, invoices and add-ons.</p>
            </div>
          </div>
        </button>
      </div>

      <!-- Help Footer -->
      <div class="mt-8 card p-5 bg-gray-50 border-none flex items-start gap-3">
        <i data-lucide="info" class="w-5 h-5 text-gray-400 mt-0.5"></i>
        <p class="text-sm text-gray-500">Need help? Visit <a class="link" href="#">Docs</a> or email <a class="link" href="mailto:dev@afroubuntutrade.co.uk">dev@afroubuntutrade.co.uk</a>.</p>
      </div>
    </section>


    <!-- ================= VIEW 2: DASHBOARD ================= -->
    <section id="view-dashboard" class="view-section">
      <div class="flex items-center gap-4 mb-6">
        <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
        <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Analytics Dashboard</h1>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Revenue -->
        <div class="card p-6">
            <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
            <p class="text-4xl font-bold mt-2 text-gray-900" id="disp_revenue">Loading...</p>
            <div class="h-32 mt-4"><canvas id="revenueChart"></canvas></div>
        </div>
        <!-- Credit -->
        <div class="card p-6 flex flex-col items-center justify-center">
            <h3 class="text-sm font-medium text-gray-500 w-full text-left">Credit Score</h3>
            <div class="relative w-40 h-20 overflow-hidden mt-4">
                <div class="absolute w-40 h-40 rounded-full border-[12px] border-gray-100"></div>
                <div class="absolute w-40 h-40 rounded-full border-[12px] border-blue-600 border-b-transparent border-r-transparent transform -rotate-45"></div>
            </div>
            <span class="text-5xl font-bold text-gray-900 -mt-8" id="disp_credit">--</span>
            <span class="pill bg-blue-50 text-blue-700 mt-2" id="disp_tier">Checking...</span>
        </div>
        <!-- Products -->
        <div class="card p-0 lg:col-span-1 overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b"><h3 class="font-semibold text-gray-700">Top Products</h3></div>
            <table class="w-full text-sm">
                <thead class="bg-white border-b text-gray-500 text-xs uppercase">
                    <tr><th class="px-6 py-2 text-left">Item</th><th class="px-6 py-2 text-right">Value</th></tr>
                </thead>
                <tbody id="list_top_products" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
      </div>
    </section>


    <!-- ================= VIEW 3: INSIGHTS ================= -->
    <section id="view-insights" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Insights & Alerts</h1>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Stock Alerts -->
            <div class="card p-6 border-l-4 border-red-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-red-100 grid place-items-center text-red-600"><i data-lucide="alert-triangle" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-gray-900">Stock Alerts</h3>
                </div>
                <ul id="list_alerts" class="space-y-3 text-sm">
                    <li class="text-gray-400 italic">No active alerts.</li>
                </ul>
            </div>

            <!-- Recommendations -->
            <div class="card p-6 border-l-4 border-blue-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-100 grid place-items-center text-blue-600"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-gray-900">AI Recommendations</h3>
                </div>
                <p class="text-sm text-gray-600 leading-relaxed">
                    Based on your sales velocity for <strong>Sugar 1kg</strong>, we recommend restocking by Friday to avoid a stockout during the weekend rush.
                </p>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                    <strong>Tip:</strong> You can request a micro-loan for this restock in the 'Connect Hub'.
                </div>
            </div>
        </div>
    </section>

    <!-- ================= VIEW 4: CONNECT HUB (NEW) ================= -->
    <section id="view-connect" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Connect Hub</h1>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="connect_list">
            <p class="text-gray-500 italic col-span-3 text-center py-10">Loading marketplace...</p>
        </div>
    </section>

    <!-- ================= VIEW 5: BUSINESS VERIFICATION (NEW) ================= -->
    <section id="view-verification" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Business Verification</h1>
        </div>

        <div class="card p-8 max-w-2xl mx-auto">
            <div id="verif_status_box" class="mb-6 hidden p-4 rounded-lg bg-yellow-50 text-yellow-800 border border-yellow-200">
                Status: <span class="font-bold" id="verif_status_text">PENDING</span>
            </div>

            <form id="verifForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Business Registration Number</label>
                    <input type="text" id="reg_num" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="e.g. BN-123456" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tax ID / TIN</label>
                    <input type="text" id="tax_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="e.g. T-987654321" required>
                </div>
                <button type="submit" class="w-full btn-primary">Submit Application</button>
            </form>
        </div>
    </section>

    <!-- Placeholders for Billing/Track -->
    <section id="view-billing" class="view-section text-center py-20">
        <button onclick="switchView('hub')" class="btn-outline mb-6 flex items-center gap-2 mx-auto"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
        <h2 class="text-2xl font-bold text-gray-300">Billing Module Loading...</h2>
    </section>
    <section id="view-track" class="view-section text-center py-20">
        <button onclick="switchView('hub')" class="btn-outline mb-6 flex items-center gap-2 mx-auto"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
        <h2 class="text-2xl font-bold text-gray-300">Tracking Module Loading...</h2>
    </section>

  </main>

  <footer class="border-t border-[color:var(--au-line)] mt-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-xs text-[color:var(--au-stone)] flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
      <p>© <span id="year"></span> Afro Ubuntu TradeNet Ltd</p>
      <div class="flex items-center gap-4">
        <button class="link" onclick="openModal('privacyModal')">Privacy</button>
        <button class="link" onclick="openModal('termsModal')">Terms</button>
      </div>
    </div>
  </footer>

  <!-- Modals -->
  <div id="privacyModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeModal('privacyModal')"></div>
    <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-2">Privacy Policy</h2>
        <div class="border rounded-lg overflow-hidden h-64"><iframe src="privacy-policy.html" class="w-full h-full"></iframe></div>
        <button class="btn-outline mt-4 text-xs" onclick="closeModal('privacyModal')">Close</button>
      </div>
    </div>
  </div>

  <div id="termsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeModal('termsModal')"></div>
    <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-2">Terms of Service</h2>
        <div class="border rounded-lg overflow-hidden h-64"><iframe src="terms-of-service.html" class="w-full h-full"></iframe></div>
        <button class="btn-outline mt-4 text-xs" onclick="closeModal('termsModal')">Close</button>
      </div>
    </div>
  </div>

  <script>
    // ---- CONFIGURATION ----
    const API_BASE = 'https://afroauth-api-g7cqa9cvc4amhqh2.uksouth-01.azurewebsites.net';
    const SIGNIN_PAGE = 'api-connection.html';

    // ---- API HELPER ----
    async function call(path, method='GET', body=null) {
        const t = localStorage.getItem('token');
        if(!t) throw new Error("No token");
        
        const opts = {
            method,
            headers: { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json' }
        };
        if(body) opts.body = JSON.stringify(body);

        const res = await fetch(API_BASE + path, opts);
        const data = await res.json().catch(()=>null);
        if (!res.ok) throw new Error((data && (data.error||data.message)) || 'HTTP ' + res.status);
        return data;
    }

    // ---- VIEW ROUTER ----
    function switchView(viewName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(`view-${viewName}`);
        if(target) target.classList.add('active');
        
        lucide.createIcons();
        window.scrollTo(0, 0);

        if(viewName === 'dashboard' || viewName === 'insights') loadAnalytics();
        if(viewName === 'connect') loadConnectHub();
        if(viewName === 'verification') loadVerification();
    }

    // ---- ANALYTICS ----
    async function loadAnalytics() {
        try {
            const data = await call('/api/v1/analytics/dashboard');
            if(!data) return;

            // Revenue
            const revEl = document.getElementById('disp_revenue');
            if(revEl) revEl.innerText = '$' + (data.revenue || 0).toLocaleString();
            
            // Credit
            const credEl = document.getElementById('disp_credit');
            const tierEl = document.getElementById('disp_tier');
            if(credEl) credEl.innerText = data.credit.score || 0;
            if(tierEl) tierEl.innerText = 'TIER: ' + (data.credit.tier || 'Unrated');

            // Table
            const tBody = document.getElementById('list_top_products');
            if(tBody) {
                tBody.innerHTML = '';
                if(data.top_products) {
                    data.top_products.forEach(p => {
                        tBody.innerHTML += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-3 text-gray-900 font-medium">${p.item}</td>
                                <td class="px-6 py-3 text-right text-gray-500">${p.qty}</td>
                                <td class="px-6 py-3 text-right text-gray-900 font-semibold">$${p.value}</td>
                            </tr>`;
                    });
                }
            }

            // Alerts
            const alertList = document.getElementById('list_alerts');
            if(alertList) {
                alertList.innerHTML = '';
                if(!data.alerts || data.alerts.length === 0) {
                    alertList.innerHTML = '<li class="text-green-600 text-sm">All clear. No alerts.</li>';
                } else {
                    data.alerts.forEach(a => {
                        if (a.item && a.item.includes("Unconfirmed")) {
                            alertList.innerHTML += `
                                <li class="flex items-center gap-2 animate-ai text-orange-600 p-2 text-sm bg-orange-50 rounded mb-2">
                                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                                    <span>AI analyzing new upload...</span>
                                </li>`;
                        } else {
                            alertList.innerHTML += `
                                <li class="flex justify-between items-center bg-gray-50 p-3 rounded-lg text-sm mb-2">
                                    <span class="text-gray-700">${a.item}</span>
                                    <span class="font-bold text-red-600">${a.stock}</span>
                                </li>`;
                        }
                    });
                }
                lucide.createIcons();
            }

            // Chart
            const ctx = document.getElementById('revenueChart');
            if(ctx && data.chart_labels) {
                if(window.myRevenueChart) window.myRevenueChart.destroy();
                window.myRevenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.chart_labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data.chart_values,
                            borderColor: '#ea580c',
                            backgroundColor: 'rgba(234,88,12,0.05)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: { display: false }, y: { display: false } } }
                });
            }
        } catch(e) { console.error(e); }
    }

    // ---- CONNECT HUB ----
    async function loadConnectHub() {
        const list = document.getElementById('connect_list');
        try {
            const data = await call('/api/v1/connect');
            if(!data.results || data.results.length === 0) {
                list.innerHTML = '<p class="text-gray-500 italic col-span-3 text-center">No other businesses found yet.</p>';
                return;
            }
            list.innerHTML = '';
            data.results.forEach(b => {
                list.innerHTML += `
                <div class="card p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${b.name}</h3>
                            <p class="text-sm text-gray-500">${b.loc}</p>
                            <span class="pill bg-gray-100 text-gray-600 mt-2 inline-block text-[10px] uppercase">${b.type}</span>
                        </div>
                        <button onclick="connectRequest('${b.id}', this)" class="btn-outline text-xs text-blue-600 border-blue-200 hover:bg-blue-50">Connect</button>
                    </div>
                </div>`;
            });
        } catch(e) { console.error(e); }
    }

    async function connectRequest(targetId, btn) {
        btn.innerText = "Sent!";
        btn.disabled = true;
        await call('/api/v1/connect', 'POST', { target_id: targetId });
    }

    // ---- VERIFICATION ----
    async function loadVerification() {
        const statusBox = document.getElementById('verif_status_box');
        const form = document.getElementById('verifForm');
        try {
            const data = await call('/api/v1/verification');
            if (data.status !== "NOT_SUBMITTED") {
                statusBox.classList.remove('hidden');
                const txt = document.getElementById('verif_status_text');
                txt.innerText = data.status;
                if(data.status === 'APPROVED') {
                    txt.className = "font-bold text-green-700";
                    statusBox.className = "mb-6 p-4 rounded-lg bg-green-50 text-green-800 border border-green-200";
                }
                form.innerHTML = '<p class="text-center text-gray-500 py-10">Application is under review by our compliance team.</p>';
            }
        } catch(e) {}
    }

    document.getElementById('verifForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const reg = document.getElementById('reg_num').value;
        const tax = document.getElementById('tax_id').value;
        await call('/api/v1/verification', 'POST', { registration_number: reg, tax_id: tax });
        alert("Application Submitted Successfully!");
        loadVerification();
    });

    // ---- INIT ----
    async function init() {
        lucide.createIcons();
        try {
            const me = await call('/api/v1/me');
            const name = me?.user?.name || '';
            const email = me?.user?.email || 'Unknown';
            let display = name ? name : (email.split('@')[0]);

            document.getElementById('welcomeName').innerText = display;
            document.getElementById('email').innerText = email;
            document.getElementById('status').innerText = 'Signed in';
        } catch(e) {
            window.location.href = `${SIGNIN_PAGE}?continue=${encodeURIComponent(location.href)}`;
        }
    }

    // ---- UI LISTENERS ----
    function openModal(id) { document.getElementById(id)?.classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id)?.classList.add('hidden'); }

    document.addEventListener("DOMContentLoaded", () => {
        const langBtn = document.getElementById("lang-btn");
        const langMenu = document.getElementById("lang-menu");
        if(langBtn && langMenu) {
            langBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                langMenu.classList.toggle("hidden");
            });
            document.addEventListener("click", (e) => {
                if(!langBtn.contains(e.target) && !langMenu.contains(e.target)) {
                    langMenu.classList.add("hidden");
                }
            });
        }
    });

    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      const email = document.getElementById('email')?.innerText?.trim();
      if (!email || email === '—') return;
      try {
        await navigator.clipboard.writeText(email);
        const btn = document.getElementById('copyBtn');
        const old = btn.innerText;
        btn.innerText = 'Copied';
        setTimeout(()=> btn.innerText = old, 1200);
      } catch {}
    });

    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = SIGNIN_PAGE;
    });

    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
