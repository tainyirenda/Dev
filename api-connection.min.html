<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <title>Afro Ubuntu • Account Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CSS / Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Chart.js for Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Translate Logic -->
  <script type="text/javascript">
  function fireGoogleTranslateEvent(el, eventName) { try { if (document.createEvent) { var event = document.createEvent("HTMLEvents"); event.initEvent(eventName, true, true); el.dispatchEvent(event); } else { el.dispatchEvent(new Event(eventName)); } } catch (e) {} }
  function setGoogleTransCookie(lang) { document.cookie = "googtrans=/en/" + lang + ";path=/;"; document.cookie = "googtrans=/en/" + lang + ";path=/;domain=" + window.location.hostname + ";"; }
  window.setLanguage = function(lang) { 
    function apply() { const c = document.querySelector(".goog-te-combo"); if (!c) return false; c.value = lang; fireGoogleTranslateEvent(c, "change"); try { localStorage.setItem("selectedLang", lang); } catch (e) {} return true; } 
    if (apply()) return; 
    const obs = new MutationObserver(() => { if (apply()) obs.disconnect(); }); 
    obs.observe(document.body, { childList: true, subtree: true }); 
    setGoogleTransCookie(lang); 
    setTimeout(() => window.location.reload(), 300); 
  };
  function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'en', includedLanguages: 'en,sw,sn,ny,yo,af,xh,zu,fr,ha,pcm,nd', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element'); }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
  
  <style>
    :root{ --au-ink:#111827; --au-stone:#6b7280; --au-line:#e5e7eb; --au-surface:#f8fafc; --au-accent:#ea580c; --au-green:#16a34a; }
    body{ font-family:Inter, sans-serif; background:var(--au-surface); color:var(--au-ink); }
    .card { background: #fff; border:1px solid var(--au-line); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    .iconwrap { width:48px; height:48px; border-radius:12px; display:grid; place-items:center; background:#f3f4f6; color:var(--au-ink); }
    .btn-outline { border:1px solid var(--au-line); border-radius:10px; padding:8px 14px; background:#fff; font-weight:500; transition:all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;}
    .btn-outline:hover { background:#f9fafb; border-color:#d1d5db; }
    .btn-primary { background: var(--au-ink); color: #fff; border-radius:10px; padding:10px 14px; font-weight:600; transition:opacity 0.2s; }
    .btn-primary:hover { opacity: 0.9; }
    .pill { padding:.2rem .6rem; border-radius:99px; font-size:.75rem; font-weight:600; }
    .link { text-decoration: underline; text-decoration-color: #d1d5db; text-underline-offset: 3px; cursor: pointer; }
    .link:hover { color: var(--au-accent); text-decoration-color: var(--au-accent); }
    
    /* View Switching Utilities */
    .view-section { display: none; animation: fadeIn 0.3s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* AI Pulse Animation */
    @keyframes pulse-orange {
      0%, 100% { color: var(--au-accent); opacity: 1; }
      50% { opacity: .6; }
    }
    .animate-ai { animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    #google_translate_element { display: none !important; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-white border-b border-[color:var(--au-line)] sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <!-- Clicking Logo returns to Hub -->
      <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('hub')">
        <div class="w-9 h-9 rounded-lg bg-[color:var(--au-ink)] grid place-items-center text-white text-[11px] font-bold">AUTN</div>
        <div class="hidden sm:block">
          <p class="text-sm font-semibold text-[color:var(--au-ink)]">Afro Ubuntu TradeNet</p>
          <p class="text-xs text-[color:var(--au-stone)]">Rooted in Africa, connected to the world</p>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <!-- Language Dropdown -->
        <div class="relative group">
           <button id="lang-btn" class="btn-outline text-xs">
             <i data-lucide="globe" class="w-3 h-3"></i> Language
           </button>
           <!-- Dropdown Menu -->
           <div id="lang-menu" class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-xl shadow-xl hidden p-1 z-50 max-h-60 overflow-y-auto">
             <button onclick="window.setLanguage('en')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">English</button>
             <button onclick="window.setLanguage('sw')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Swahili</button>
             <button onclick="window.setLanguage('fr')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">French</button>
             <button onclick="window.setLanguage('ha')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Hausa</button>
             <button onclick="window.setLanguage('pcm')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Pidgin</button>
             <button onclick="window.setLanguage('nd')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Ndebele</button>
             <button onclick="window.setLanguage('yo')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Yoruba</button>
             <button onclick="window.setLanguage('zu')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Zulu</button>
             <button onclick="window.setLanguage('xh')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Xhosa</button>
             <button onclick="window.setLanguage('sn')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Shona</button>
             <button onclick="window.setLanguage('ny')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Nyanja</button>
             <button onclick="window.setLanguage('af')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Afrikaans</button>
           </div>
        </div>
        
        <!-- Home Button -->
        <a href="index.html" class="btn-outline text-xs text-gray-700 hover:text-black">Home</a>
        
        <button id="logoutBtn" class="btn-outline text-xs text-red-600 border-red-100 hover:bg-red-50">Log out</button>
      </nav>
    </div>
    <div class="h-[3px] bg-gradient-to-r from-[color:var(--au-accent)] to-[color:var(--au-ink)]"></div>
  </header>

  <!-- Main Content Container -->
  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- ================= VIEW 1: HUB (DEFAULT) ================= -->
    <section id="view-hub" class="view-section active">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-extrabold text-[color:var(--au-ink)]">Your account</h1>
          <p class="text-[15px] text-[color:var(--au-stone)]">
            Welcome back, <span id="welcomeName" class="font-semibold text-[color:var(--au-ink)]">User</span>
          </p>
        </div>
        <span class="pill bg-green-100 text-green-700" id="status">Signed in</span>
      </div>

      <!-- Identity Card -->
      <div class="card p-4 flex items-center justify-between gap-3 mb-8">
        <div class="flex items-center gap-3">
          <div class="iconwrap"><i data-lucide="user" class="w-5 h-5"></i></div>
          <div class="min-w-0">
            <p class="text-xs text-[color:var(--au-stone)] uppercase tracking-wider font-semibold">Signed in as</p>
            <p class="text-base font-medium truncate" id="email">—</p>
          </div>
        </div>
        <button class="btn-outline text-xs" id="copyBtn">Copy</button>
      </div>

      <!-- Module Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        
        <!-- Dashboard Card (Purple Theme) -->
        <button onclick="switchView('dashboard')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-purple-100 group-hover:text-purple-600 transition-colors"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Dashboard</h3>
              <p class="mt-1 text-sm text-gray-500">Usage, APIs and performance KPIs.</p>
            </div>
          </div>
        </button>

        <!-- Insights Card (Indigo Theme) -->
        <button onclick="switchView('insights')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors"><i data-lucide="line-chart" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Insights</h3>
              <p class="mt-1 text-sm text-gray-500">Predictive analysis, alerts & recommendations.</p>
            </div>
          </div>
        </button>

        <!-- Connect Hub -->
        <button onclick="switchView('connect')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-orange-100 group-hover:text-orange-600 transition-colors"><i data-lucide="messages-square" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Connect Hub</h3>
              <p class="mt-1 text-sm text-gray-500">Discover partners & AI-assisted matching.</p>
            </div>
          </div>
        </button>

        <!-- Verification -->
        <button onclick="switchView('verification')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-green-100 group-hover:text-green-600 transition-colors"><i data-lucide="badge-check" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Business Verification</h3>
              <p class="mt-1 text-sm text-gray-500">Confirm your business details.</p>
            </div>
          </div>
        </button>

        <!-- Track App (Teal Theme) -->
        <button onclick="switchView('track')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-teal-100 group-hover:text-teal-600 transition-colors"><i data-lucide="receipt-text" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Track Application</h3>
              <p class="mt-1 text-sm text-gray-500">See submission and review status.</p>
            </div>
          </div>
        </button>

        <!-- Billing -->
        <button onclick="switchView('billing')" class="card p-6 text-left hover:shadow-md transition-all group w-full">
          <div class="flex items-start gap-4">
            <div class="iconwrap group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors"><i data-lucide="credit-card" class="w-6 h-6"></i></div>
            <div>
              <h3 class="text-lg font-bold text-gray-900">Billing & Plans</h3>
              <p class="mt-1 text-sm text-gray-500">Manage plan, billing and add-ons.</p>
            </div>
          </div>
        </button>
      </div>

      <!-- Help Footer -->
      <div class="mt-8 card p-5 bg-gray-50 border-none flex items-start gap-3">
        <i data-lucide="info" class="w-5 h-5 text-gray-400 mt-0.5"></i>
        <p class="text-sm text-gray-500">Need help? Visit <a class="link" href="docs.html" target="_blank" rel="noopener noreferrer">Docs</a> or email <a class="link" href="mailto:dev@afroubuntutrade.co.uk">dev@afroubuntutrade.co.uk</a>.</p>
      </div>
    </section>


    <!-- ================= VIEW 2: DASHBOARD ================= -->
    <section id="view-dashboard" class="view-section">
      <div class="flex items-center gap-4 mb-6">
        <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
        <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Analytics Dashboard</h1>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Revenue -->
        <div class="card p-6">
            <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
            <p class="text-4xl font-bold mt-2 text-gray-900" id="disp_revenue">Loading...</p>
            <div class="h-32 mt-4"><canvas id="revenueChart"></canvas></div>
        </div>
        <!-- Credit -->
        <div class="card p-6 flex flex-col items-center justify-center">
            <h3 class="text-sm font-medium text-gray-500 w-full text-left">Credit Score</h3>
            <div class="relative w-40 h-20 overflow-hidden mt-4">
                <div class="absolute w-40 h-40 rounded-full border-[12px] border-gray-100"></div>
                <div class="absolute w-40 h-40 rounded-full border-[12px] border-blue-600 border-b-transparent border-r-transparent transform -rotate-45"></div>
            </div>
            <span class="text-5xl font-bold text-gray-900 -mt-8" id="disp_credit">--</span>
            <span class="pill bg-blue-50 text-blue-700 mt-2" id="disp_tier">Checking...</span>
        </div>
        <!-- Products -->
        <div class="card p-0 lg:col-span-1 overflow-hidden">
            <div class="bg-gray-50 px-6 py-4 border-b"><h3 class="font-semibold text-gray-700">Top Products</h3></div>
            <table class="w-full text-sm">
                <thead class="bg-white border-b text-gray-500 text-xs uppercase">
                    <tr><th class="px-6 py-2 text-left">Item</th><th class="px-6 py-2 text-right">Value</th></tr>
                </thead>
                <tbody id="list_top_products" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
      </div>
    </section>


    <!-- ================= VIEW 3: INSIGHTS ================= -->
    <section id="view-insights" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Insights & Alerts</h1>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Stock Alerts -->
            <div class="card p-6 border-l-4 border-red-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-red-100 grid place-items-center text-red-600"><i data-lucide="alert-triangle" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-gray-900">Stock Alerts</h3>
                </div>
                <ul id="list_alerts" class="space-y-3 text-sm">
                    <li class="text-gray-400 italic">No active alerts.</li>
                </ul>
            </div>

            <!-- Recommendations -->
            <div class="card p-6 border-l-4 border-blue-500">
                <div class="flex items-center gap-2 mb-4">
                    <div class="w-8 h-8 rounded-full bg-blue-100 grid place-items-center text-blue-600"><i data-lucide="sparkles" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-gray-900">AI Recommendations</h3>
                </div>
                <p class="text-sm text-gray-600 leading-relaxed">
                    Based on your sales velocity for <strong>Sugar 1kg</strong>, we recommend restocking by Friday to avoid a stockout during the weekend rush.
                </p>
                <div class="mt-4 p-3 bg-blue-50 rounded-lg text-xs text-blue-800">
                    <strong>Tip:</strong> You can request a micro-loan for this restock in the 'Connect Hub'.
                </div>
            </div>
        </div>
    </section>

    <!-- ================= VIEW 4: CONNECT HUB & CHAT ================= -->
    <section id="view-connect" class="view-section relative">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Connect Hub</h1>
            </div>
            
            <!-- Notifications Bell -->
            <div class="relative cursor-pointer" onclick="loadRequests()">
                <i data-lucide="bell" class="w-6 h-6 text-gray-600"></i>
                <span id="notif_badge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="flex flex-wrap items-center gap-3 mb-6 bg-white p-3 rounded-xl border shadow-sm">
    
    <!-- Wrapper for elements we want to hide/show -->
    <div id="filter_controls_wrapper" class="flex flex-wrap items-center gap-3 flex-1">

        <!-- Type Filter -->
        <select id="filter_type" onchange="loadConnectHub('browse')" class="text-sm border-gray-200 rounded-lg px-3 py-2 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-orange-500">
            <option value="">All Types</option>
            <option value="Retailer">Retailer</option>
            <option value="FMCG">FMCG</option>
            <option value="NGO">NGO</option>
            <option value="Development Partner">Development Partner</option>
            <option value="Fintech">Fintech</option>
        </select>

        <!-- Location Filter -->
        <select id="filter_loc" onchange="loadConnectHub('browse')" class="text-sm border-gray-200 rounded-lg px-3 py-2 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-orange-500 w-44">
            <option value="">All Locations</option>
        </select>

      <!-- Search Bar -->
        <div class="relative flex-1 min-w-[200px]">
            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
            <input type="text" id="filter_search" oninput="debouncedSearch()" placeholder="Search names..." 
                   class="w-full pl-10 pr-4 py-2 text-sm border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-1 focus:ring-orange-500 outline-none transition-all">
        </div>
    </div>

    <!-- The Tabs stay visible -->
    <div class="flex gap-4 ml-auto border-l pl-4">
        <button onclick="loadConnectHub('browse')" id="tab-browse" class="text-sm font-semibold text-orange-600">Explore</button>
        <button onclick="loadConnectHub('connections')" id="tab-network" class="text-sm text-gray-500 hover:text-gray-700">My Network</button>
    </div>
</div>
        <!-- Requests Panel -->
        <div id="requests_panel" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="text-sm font-bold text-yellow-800 mb-3">Pending Requests</h3>
            <div id="requests_list" class="space-y-2"></div>
        </div>

        <!-- Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="connect_list">
            <p class="text-gray-500 italic col-span-3 text-center py-10">Loading...</p>
        </div>
        
        <!-- Chat Modal  -->
        <div id="chat_modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-end sm:items-center justify-center">
        
             <div class="bg-white w-full sm:w-[450px] h-[80vh] sm:h-[600px] sm:rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                    <div><h3 class="font-bold text-gray-800" id="chat_partner_name">Name</h3><p class="text-xs flex items-center gap-1" id="chat_status_container">
            <span id="chat_status_dot" class="w-2 h-2 rounded-full"></span> 
            <span id="chat_status_text">Offline</span>
        </p></div>
                    <button onclick="closeChat()" class="p-2 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
               <div class="bg-amber-50 p-3 text-[10px] text-amber-800 leading-tight border-b border-amber-100">
    <i data-lucide="shield-alert" class="w-3 h-3 inline-block mr-1"></i>
    Data/information and business dealings shared here must be kept confidential to each parties of this chat. We are not liable for any decisions made by, or between, either party. However, We will act accordingly to reported behaviour. Please see our Data Privacy, Terms of Service and Ethical Data & AI policies for more information, or email info@afroubuntutrade.co.uk.
</div>
                <div id="chat_box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
                <div class="p-3 border-t bg-gray-50 flex gap-2">
                    <input type="text" id="chat_input" placeholder="Type a message..." class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:border-orange-500">
                    <button onclick="sendMessage()" class="bg-orange-600 text-white p-2 rounded-full hover:bg-orange-700"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

      <!-- Business Profile Detail Modal -->
<div id="profile_detail_modal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col">
        <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
            <h3 class="font-bold text-gray-900">Business Profile</h3>
            <button onclick="closeProfileModal()" class="p-1 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-6 space-y-5 overflow-y-auto max-h-[70vh]">
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Business Name</label>
                <div class="flex items-center gap-2 mt-1">
                    <h2 id="pd_name" class="text-2xl font-extrabold text-gray-900 leading-tight">--</h2>
                    <span id="pd_verified" class="hidden"><i data-lucide="badge-check" class="w-6 h-6 text-blue-500 fill-blue-50"></i></span>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Sector</label>
                    <p id="pd_type" class="font-semibold text-indigo-600 mt-1">--</p>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Match Score</label>
                    <p id="pd_score" class="font-semibold text-orange-600 mt-1">--</p>
                </div>
            </div>
            <div>
                <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Address / Location</label>
                <p id="pd_loc" class="text-gray-700 mt-1 text-base">--</p>
            </div>
            <div id="pd_verif_box" class="p-4 bg-blue-50 rounded-xl border border-blue-100 hidden">
                <label class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Verification Details</label>
                <div class="mt-2 text-sm text-blue-900 space-y-1">
                    <p><strong>Registration:</strong> <span id="pd_reg_num">--</span></p>
                    <p><strong>Tax ID:</strong> <span id="pd_tax_id">--</span></p>
                </div>
            </div>
        </div>
        <div class="p-6 bg-gray-50 border-t flex gap-3">
             <button id="pd_chat_btn" class="flex-1 btn-primary text-sm py-2.5">Chat Now</button>
             <button onclick="closeProfileModal()" class="flex-1 btn-outline text-sm py-2.5">Close</button>
        </div>
    </div>
</div>
      
    </section>

    

    
    <!-- ================= VIEW 5: BUSINESS VERIFICATION ================= -->
    <section id="view-verification" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Business Verification</h1>
        </div>

        <div class="card p-8 max-w-2xl mx-auto">
            
            <!-- STATUS BANNER (Dynamic) -->
            <div id="verif_status_card" class="hidden mb-6 p-5 rounded-lg border flex flex-col gap-3">
                <div class="flex items-center gap-3">
                    <div id="verif_icon_box" class="w-10 h-10 rounded-full flex items-center justify-center bg-gray-100">
                        <i id="verif_icon" data-lucide="info" class="w-5 h-5 text-gray-600"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg" id="verif_title">Application Status</h3>
                        <p class="text-sm" id="verif_desc">Checking...</p>
                    </div>
                </div>
                <!-- The Edit Button -->
                <button id="btn_edit_verif" onclick="enableVerifEdit()" class="btn-outline text-xs self-end hidden">
                    Edit & Resubmit
                </button>
            </div>

            <!-- FORM -->
            <form id="verifForm" class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 mb-6">
                    <p><strong>Note:</strong> Verification is primarily for Organizations (FMCG, FinTech, NGO etc.). Retailers are verified via transaction history, but can also be verified here.</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Business Name</label>
                    <input type="text" id="v_biz_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Business Location</label>
                        <!-- Country Dropdown (Populated by JS) -->
                        <select id="v_biz_loc" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border bg-white" required>
                            <option value="">Select Country</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Organization Type</label>
                        <select id="v_biz_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border bg-white" required>
                            <option value="">Select Type</option>
                            <option value="Retailer">Retailer / Vendor / Trader</option>
                            <option value="FMCG">FMCG / Supplier / Distributor</option>
                            <option value="Fintech">Fintech / Bank</option>
                            <option value="Micro-Lender">Micro-Lender</option>
                            <option value="NGO">NGO / Aid</option>
                            <option value="Development Partner">Development Partner</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Business Registration Number</label>
                    <input type="text" id="v_reg_num" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tax ID / TIN <span class="text-gray-400 font-normal">(Optional)</span></label>
                    <input type="text" id="v_tax_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                </div>

                <button type="submit" class="w-full btn-primary mt-4">Submit Application</button>
            </form>
        </div>
    </section>

    <!-- ================= VIEW 6: TRACK APPLICATION ================= -->
    <section id="view-track" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Application Status</h1>
        </div>

        <div class="card p-8 max-w-3xl mx-auto">
            <!-- Header Info -->
            <div class="text-center mb-10">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-50 text-blue-600 mb-4">
                    <i data-lucide="file-search" class="w-8 h-8"></i>
                </div>
                <h2 class="text-xl font-bold text-gray-900">Business Verification</h2>
                <p class="text-gray-500 text-sm mt-1">Tracking ID: <span id="track_id" class="font-mono text-gray-700">--</span></p>
            </div>

            <!-- Progress Steps -->
            <div class="relative">
                <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-200"></div>
                
                <!-- Step 1 -->
                <div class="relative flex items-start mb-8 group">
                    <div class="absolute left-0 w-16 flex justify-center">
                        <div id="step1_icon" class="w-8 h-8 bg-gray-200 rounded-full border-4 border-white flex items-center justify-center text-white z-10">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="ml-20">
                        <h3 class="font-bold text-gray-900">Application Submitted</h3>
                        <p class="text-sm text-gray-500 mt-1">Your details have been received by our compliance team.</p>
                        <p id="step1_date" class="text-xs text-gray-400 mt-1">--</p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="relative flex items-start mb-8 group">
                    <div class="absolute left-0 w-16 flex justify-center">
                        <div id="step2_icon" class="w-8 h-8 bg-gray-200 rounded-full border-4 border-white flex items-center justify-center text-white z-10">
                            <i data-lucide="loader-2" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="ml-20">
                        <h3 id="step2_title" class="font-bold text-gray-900">Under Review</h3>
                        <p id="step2_desc" class="text-sm text-gray-500 mt-1">We are verifying your registration details with local authorities.</p>
                        <p id="step2_date" class="text-xs text-gray-400 mt-1">--</p>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="relative flex items-start group">
                    <div class="absolute left-0 w-16 flex justify-center">
                        <div id="step3_icon" class="w-8 h-8 bg-gray-200 rounded-full border-4 border-white flex items-center justify-center text-white z-10">
                            <i data-lucide="award" class="w-4 h-4"></i>
                        </div>
                    </div>
                    <div class="ml-20">
    <h3 id="step3_title" class="font-bold text-gray-900">Verification Approved</h3>
    <p id="step3_date" class="text-xs text-gray-400 mt-1">--</p>
</div>
                </div>
            </div>

            <!-- Action Area -->
            <div id="track_action" class="mt-10 p-4 bg-gray-50 rounded-lg text-center hidden">
                <p class="text-sm text-gray-600 mb-3">Verification failed? You may need to resubmit documents.</p>
                <button onclick="switchView('verification')" class="btn-outline text-xs">Update Information</button>
            </div>
        </div>
    </section>

    <!-- ================= VIEW 7: BILLING & PLANS ================= -->
    <section id="view-billing" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Billing & Plans</h1>
        </div>

        <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8 text-sm text-gray-600 flex items-start gap-3">
            <i data-lucide="info" class="w-5 h-5 mt-0.5 shrink-0"></i>
            <p>All plans include WhatsApp onboarding, secure data handling, and access to our customer success team. Prices are indicative and may vary with scope.</p>
        </div>

        <div class="space-y-10">

            <!-- Retailers & Merchants Table (Free Tier) -->
<div class="card overflow-hidden">
    <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex items-center gap-3">
        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
            <i data-lucide="store" class="w-4 h-4"></i>
        </div>
        <div>
            <h3 class="text-lg font-bold text-indigo-800">Retailers, Vendors & Traders</h3>
            <p class="text-xs text-indigo-600">Supporting local commerce with free digital tools. (To apply, set business type to 'retailers' tier)</p>
        </div>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
            <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                <tr>
                    <th class="px-6 py-3 font-medium">Tier</th>
                    <th class="px-6 py-3 font-medium">Price Range</th>
                    <th class="px-6 py-3 font-medium">What's Included</th>
                    <th class="px-6 py-3 text-right">Action</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 font-bold text-gray-900">Community</td>
                    <td class="px-6 py-4">
                        <span class="text-green-600 font-bold">Free Forever</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600">
                        Full analytics dashboard, Connect Hub access, WhatsApp-based inventory-sales tracking & credit profiling, and AI-generated recommendations & stock alerts.
                    </td>
                    <td class="px-6 py-4 text-right">
                        <!-- We show this as the active plan by default for retailers -->
                        <span class="pill bg-indigo-100 text-indigo-700">Included</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
            
            <!-- FMCGs Table -->
            <div id="billing_fmcg_section" class="card overflow-hidden">
                <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i data-lucide="package" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-green-800">FMCGs (Consumer Goods & Distributors)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 font-medium">Tier</th>
                                <th class="px-6 py-3 font-medium">Price Range</th>
                                <th class="px-6 py-3 font-medium">What's Included</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Starter</td>
                                <td class="px-6 py-4 text-gray-600">$1,500/m <span class="text-xs text-gray-400">(£1,200)</span></td>
                                <td class="px-6 py-4 text-gray-600">1 region, inventory + sales dashboards, basic forecasts, limited API</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('FMCG_STARTER')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50 bg-gray-50/50">
                                <td class="px-6 py-4 font-bold text-gray-900">Growth</td>
                                <td class="px-6 py-4 text-gray-600">$3,500/m <span class="text-xs text-gray-400">(£2,800)</span></td>
                                <td class="px-6 py-4 text-gray-600">Multi-region, advanced forecasting, competitor insights, API integration</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('FMCG_GROWTH')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Enterprise</td>
                                <td class="px-6 py-4 text-gray-600">$75k–$150k/yr <span class="text-xs text-gray-400">(£60k–£120k)</span></td>
                                <td class="px-6 py-4 text-gray-600">Unlimited coverage, custom analytics, white-label dashboards, SLAs</td>
                                <td class="px-6 py-4 text-right"><button onclick="contactSales('FMCG_ENTERPRISE')" class="btn-outline text-xs border-orange-200 text-orange-600 hover:bg-orange-50">Contact</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- NGOs Table -->
            <div id="billing_ngo_section" class="card overflow-hidden">
                <div class="bg-orange-50 px-6 py-4 border-b border-orange-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i data-lucide="users" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-orange-800">NGOs & Development Partners</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 font-medium">Tier</th>
                                <th class="px-6 py-3 font-medium">Price Range</th>
                                <th class="px-6 py-3 font-medium">What's Included</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Starter</td>
                                <td class="px-6 py-4 text-gray-600">$300/m <span class="text-xs text-gray-400">(£240)</span></td>
                                <td class="px-6 py-4 text-gray-600">Basic data for 1 region, monitoring dashboards, CSV/Excel export</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('NGO_STARTER')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50 bg-gray-50/50">
                                <td class="px-6 py-4 font-bold text-gray-900">Growth</td>
                                <td class="px-6 py-4 text-gray-600">$1,200/m <span class="text-xs text-gray-400">(£950)</span></td>
                                <td class="px-6 py-4 text-gray-600">Multi-region, real-time dashboards, grant reporting, alerts</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('NGO_GROWTH')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Enterprise</td>
                                <td class="px-6 py-4 text-gray-600">$25k–$100k/yr <span class="text-xs text-gray-400">(£20k–£80k)</span></td>
                                <td class="px-6 py-4 text-gray-600">Custom program analytics, donor-facing reports, field integration</td>
                                <td class="px-6 py-4 text-right"><button onclick="contactSales('NGO_ENTERPRISE')" class="btn-outline text-xs border-orange-200 text-orange-600 hover:bg-orange-50">Contact</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Fintechs Table -->
            <div id="billing_fintech_section" class="card overflow-hidden">
                <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i data-lucide="banknote" class="w-4 h-4"></i></div>
                    <h3 class="text-lg font-bold text-blue-800">FinTechs (Banks, Microfinance)</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-500 uppercase bg-gray-50 border-b">
                            <tr>
                                <th class="px-6 py-3 font-medium">Tier</th>
                                <th class="px-6 py-3 font-medium">Price Range</th>
                                <th class="px-6 py-3 font-medium">What's Included</th>
                                <th class="px-6 py-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Starter</td>
                                <td class="px-6 py-4 text-gray-600">$750/m <span class="text-xs text-gray-400">(£600)</span></td>
                                <td class="px-6 py-4 text-gray-600">Basic credit-scoring API, retailer profiles, risk-tier insights</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('FINTECH_STARTER')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50 bg-gray-50/50">
                                <td class="px-6 py-4 font-bold text-gray-900">Growth</td>
                                <td class="px-6 py-4 text-gray-600">$2,500/m <span class="text-xs text-gray-400">(£2,000)</span></td>
                                <td class="px-6 py-4 text-gray-600">Expanded API, repayment analysis, portfolio monitoring</td>
                                <td class="px-6 py-4 text-right"><button onclick="selectPlanTest('FINTECH_GROWTH')" class="btn-outline text-xs border-black-200 text-black-600 hover:bg-orange-50">Select Plan</button></td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-bold text-gray-900">Enterprise</td>
                                <td class="px-6 py-4 text-gray-600">$50k–$200k/yr <span class="text-xs text-gray-400">(£40k–£160k) + rev share</span></td>
                                <td class="px-6 py-4 text-gray-600">Full API, predictive risk engine, dedicated integration</td>
                                <td class="px-6 py-4 text-right"><button onclick="contactSales('FINTECH_ENTERPRISE')" class="btn-outline text-xs border-orange-200 text-orange-600 hover:bg-orange-50">Contact</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- ================= VIEW: RESTRICTED ================= -->
    <section id="view-restricted" class="view-section text-center py-16">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-red-50 text-red-600 mb-6">
            <i data-lucide="lock" class="w-10 h-10"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-900">Verification Required</h2>
        <p class="text-gray-600 mt-2 max-w-md mx-auto">
            As an Organization (Non-Retailer), you must have an <strong>Approved Business Verification</strong> to access the Dashboard, Insights, and Connect Hub.
        </p>
        <div class="mt-8 flex justify-center gap-4">
            <button onclick="switchView('verification')" class="btn-primary">Go to Verification</button>
            <button onclick="switchView('track')" class="btn-outline">Track Status</button>
        </div>
    </section>
    
  </main>

  <footer class="border-t border-[color:var(--au-line)] mt-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-xs text-[color:var(--au-stone)] flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
      <p>© <span id="year"></span> Afro Ubuntu TradeNet Ltd</p>
      <div class="flex items-center gap-4">
        <button class="link" onclick="openModal('privacyModal')">Privacy</button>
        <button class="link" onclick="openModal('termsModal')">Terms</button>
        <button class="link" onclick="openModal('ethicsModal')">Ethics</button>
      </div>
    </div>
  </footer>

  <!-- Modals -->
  <div id="privacyModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeModal('privacyModal')"></div>
    <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-2">Privacy Policy</h2>
        <div class="border rounded-lg overflow-hidden h-64"><iframe src="privacy-policy.html" class="w-full h-full"></iframe></div>
        <div class="flex justify-end mt-4"><button class="btn-outline mt-4 text-xs" onclick="closeModal('privacyModal')">Close</button></div>
      </div>
    </div>
  </div>

  <div id="termsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeModal('termsModal')"></div>
    <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-2">Terms of Service</h2>
        <div class="border rounded-lg overflow-hidden h-64"><iframe src="terms-of-service.html" class="w-full h-full"></iframe></div>
        <div class="flex justify-end mt-4"><button class="btn-outline mt-4 text-xs" onclick="closeModal('termsModal')">Close</button></div>
      </div>
    </div>
  </div>

  <div id="ethicsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" onclick="closeModal('ethicsModal')"></div>
    <div class="relative z-10 flex items-center justify-center min-h-screen px-4">
      <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold mb-2">Ethical Data/AI Use Policy</h2>
        <div class="border rounded-lg overflow-hidden h-64"><iframe src="ethical-ai-policy.html" class="w-full h-full"></iframe></div>
        <div class="flex justify-end mt-4"><button class="btn-outline mt-4 text-xs" onclick="closeModal('ethicsModal')">Close</button></div>
      </div>
    </div>
  </div>

  <div id="report_modal" class="fixed inset-0 z-[60] hidden bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-1">Report <span id="report_target_name">User</span></h3>
        <p class="text-xs text-gray-500 mb-4">Please specify the nature of your report. This will be sent to our specialised departments.</p>
        
        <label class="block text-xs font-semibold text-gray-700 uppercase mb-1">Nature of Report</label>
        <select id="report_category" class="w-full border rounded-lg p-2 text-sm mb-4 bg-gray-50">
            <option value="ethics">Ethical Behavior / Misconduct</option>
            <option value="privacy">Privacy / Data Handling Concern</option>
            <option value="dpo">Data Breach / DPO Inquiry</option>
            <option value="legal">Legal Dispute / Contractual Issue</option>
            <option value="dev">Technical Misuse / Bug</option>
        </select>

        <label class="block text-xs font-semibold text-gray-700 uppercase mb-1">Details</label>
        <textarea id="report_details" placeholder="Describe the behavior or incident..." class="w-full border rounded-lg p-2 text-sm h-24 mb-6 focus:ring-1 focus:ring-orange-500 outline-none"></textarea>

        <div class="flex gap-3">
            <button onclick="closeReportModal()" class="flex-1 btn-outline text-xs">Cancel</button>
            <button onclick="submitReport()" id="btn_submit_report" class="flex-1 bg-red-600 text-white rounded-lg text-xs font-bold py-2 hover:bg-red-700">Submit Report</button>
        </div>
    </div>
</div>

  <script>
    // ---- CONFIGURATION ----
    const API_BASE = 'https://afroauth-api-g7cqa9cvc4amhqh2.uksouth-01.azurewebsites.net';
    const SIGNIN_PAGE = 'api-connection.html';

    // ---- GLOBAL STATE ----
    let currentUserType = 'Retailer';
    let currentVerifStatus = 'NOT_SUBMITTED';
    let currentConnectResults = [];

    // ---- API HELPER ----
    async function call(path, method='GET', body=null) {
        const t = localStorage.getItem('token');
        if(!t) throw new Error("No token");
        
        const opts = {
            method,
            headers: { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json' }
        };
        if(body) opts.body = JSON.stringify(body);

        const res = await fetch(API_BASE + path, opts);
        const data = await res.json().catch(()=>null);
        
        // Return explicit error for access control
        if (res.status === 403) throw new Error("VERIFICATION_REQUIRED");
        if (!res.ok) throw new Error((data && (data.error||data.message)) || 'HTTP ' + res.status);
        
        return data;
    }

    // ---- VIEW ROUTER ----
    async function switchView(viewName) {
        // 1. Fetch fresh status from the API
        let me;
        try {
            me = await call('/api/v1/me');
            currentUserType = me.user.type;
            currentVerifStatus = me.user.status;
            const currentPaymentStatus = me.user.payment_status;

            // 2. ACCESS CONTROL CHECK
            if (['dashboard', 'insights', 'connect'].includes(viewName)) {
                if (currentUserType !== 'Retailer') {
                    if (currentVerifStatus !== 'APPROVED') {
                        viewName = 'restricted';
                    } 
                    else if (currentPaymentStatus !== 'ACTIVE') {
                        viewName = 'billing';
                        alert("Account Approved! Please select a package to activate your portal.");
                    }
                }
            }
        } catch(e) {
            console.error("Auth check failed", e);
        }

        // 3. SWITCH UI VISIBILITY
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(`view-${viewName}`);
        if(target) target.classList.add('active');
      
        // --- THE TRIGGER: Run constraints if on the billing page ---
        if (viewName === 'billing') {
            applyBillingConstraints();
        }

        // --- BILLING UX CONSTRAINTS ---
        if (viewName === 'billing') {
            // Targets buttons for BOTH plan selection and contact sales
            const billingButtons = document.querySelectorAll('button[onclick^="selectPlanTest"], button[onclick^="contactSales"]');
            
            billingButtons.forEach(btn => {
                if (currentUserType === 'Retailer') {
                    // 1. Hide ALL billing buttons for retailers (they use the free tier)
                    btn.classList.add('hidden');
                } 
                else if (currentVerifStatus !== 'APPROVED') {
                    // 2. Gray out buttons for non-approved organizations
                    btn.disabled = true;
                    btn.classList.add('grayscale', 'opacity-50', 'cursor-not-allowed');
                } 
                else {
                    // 3. Ensure buttons are normal for approved organizations
                    btn.disabled = false;
                    btn.classList.remove('hidden', 'grayscale', 'opacity-50', 'cursor-not-allowed');
                }
            });
        }
      
        lucide.createIcons();
        window.scrollTo(0, 0);

        // 4. LOAD DATA
        if(viewName === 'dashboard' || viewName === 'insights') loadAnalytics();
        if(viewName === 'connect') loadConnectHub();
        if(viewName === 'verification') loadVerification();
        if(viewName === 'track') loadTracking();
    }
    // Global state for search timing
    let searchTimeout;

    // "Live Search" wrapper
    function debouncedSearch() {
        // 1. Clear the timer if the user is still typing
        clearTimeout(searchTimeout);
        
        // 2. Set a new timer
        searchTimeout = setTimeout(() => {
            // 3. Trigger the existing load function after 400ms pause
            loadConnectHub(); 
        }, 400);
    }

    function applyBillingConstraints() {
        const fmcgSec = document.getElementById('billing_fmcg_section');
        const ngoSec = document.getElementById('billing_ngo_section');
        const fintechSec = document.getElementById('billing_fintech_section');

        // 1. Sector Isolation: Hide irrelevant tables entirely
        if (fmcgSec) fmcgSec.classList.add('hidden');
        if (ngoSec) ngoSec.classList.add('hidden');
        if (fintechSec) fintechSec.classList.add('hidden');

        if (currentUserType === 'FMCG') {
            if (fmcgSec) fmcgSec.classList.remove('hidden');
        } else if (currentUserType === 'NGO' || currentUserType === 'Development Partner') {
            if (ngoSec) ngoSec.classList.remove('hidden');
        } else if (currentUserType === 'Fintech' || currentUserType === 'Micro-Lender') {
            if (fintechSec) fintechSec.classList.remove('hidden');
        }

        // 2. Button Visuals (Grayscale for non-approved users)
        const billingButtons = document.querySelectorAll('button[onclick^="selectPlanTest"], button[onclick^="contactSales"]');
        
        billingButtons.forEach(btn => {
            if (currentUserType === 'Retailer') {
                btn.classList.add('hidden'); // Retailers see nothing in paid tables
            } 
            else if (currentVerifStatus !== 'APPROVED') {
                btn.disabled = true;
                btn.classList.add('grayscale', 'opacity-50', 'cursor-not-allowed');
            } 
            else {
                btn.disabled = false;
                btn.classList.remove('hidden', 'grayscale', 'opacity-50', 'cursor-not-allowed');
            }
        });
    }

    // ---- PAYMENT HUB ----
    async function selectPlanTest(tierName) {
        // 1. Logic Check
        if (currentUserType === 'Retailer') {
            alert("As a Retailer/Vendor/Trader, you already have full access via the Free Community Tier. No further activation is required.");
            return;
        }

        if (currentVerifStatus !== 'APPROVED') {
            alert("Your account must be approved before selecting a plan.");
            return;
        }

        const displayName = tierName.replace('_', ' ');
        if(!confirm(`Confirm selection of ${displayName} plan?`)) return;
        
        try {
            const res = await call('/api/v1/payments/activate-test', 'POST', { tier: tierName });
            alert("Success! Package activated. You now have full access.");
            window.location.reload(); 
        } catch(e) {
            alert("Activation failed: " + e.message);
        }
    }

    // CONTACT SALES WITH REDIRECT
    async function contactSales(tierName) {
        const displayName = tierName.replace('_', ' ');
        
        if(!confirm(`Would you like to request a consultation for the ${displayName} plan?`)) return;

        try {
            await call('/api/v1/payments/contact-sales', 'POST', { tier: tierName });
            alert("Inquiry Sent! A specialist from our team will reach out to you shortly.");
            
            // Redirect back to the Hub (Main Page) after inquiry
            switchView('hub'); 
        } catch(e) {
            alert("Failed to send inquiry: " + e.message);
        }
    }

    
    // ---- LOAD CONNECT HUB ----
    async function loadConnectHub(mode = 'browse') {
        const list = document.getElementById('connect_list');
        const filterWrapper = document.getElementById('filter_controls_wrapper');
        list.innerHTML = '<p class="text-gray-500 col-span-3 text-center py-10"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2"></i>Loading...</p>';
        
        // Tab UI logic
        document.getElementById('tab-browse').className = mode==='browse' ? "text-sm font-semibold text-orange-600 border-b-2 border-orange-500 pb-2" : "text-sm text-gray-500 hover:text-gray-700 pb-2";
        document.getElementById('tab-network').className = mode==='connections' ? "text-sm font-semibold text-orange-600 border-b-2 border-orange-500 pb-2" : "text-sm text-gray-500 hover:text-gray-700 pb-2";

        // --- HIDE/SHOW FILTERS ---
        if (mode === 'connections') {
            filterWrapper.classList.add('hidden');
        } else {
            filterWrapper.classList.remove('hidden');
        }

        const search = document.getElementById('filter_search')?.value || '';
        const type = document.getElementById('filter_type')?.value || '';
        const loc = document.getElementById('filter_loc')?.value || '';

        try {
            let url = `/api/v1/connect?mode=${mode}`;
            // Only attach filters if we are in 'browse' mode
            if (mode === 'browse') {
                if(search) url += `&search=${encodeURIComponent(search)}`;
                if(type) url += `&type=${encodeURIComponent(type)}`;
                if(loc) url += `&loc=${encodeURIComponent(loc)}`;
            }

            const data = await call(url);
            list.innerHTML = '';
            
            if(!data.results || data.results.length === 0) {
                const msg = mode === 'browse' ? `No matches found.` : "You haven't connected with any businesses yet.";
                list.innerHTML = `<p class="text-gray-400 col-span-3 text-center py-20 italic">${msg}</p>`;
                return;
            }

            currentConnectResults = data.results;
            const isConnected = (mode === 'connections');

            currentConnectResults.forEach((b, index) => {
                const escapedName = (b.name || '').replace(/'/g, "\\'"); 
                const verifiedBadge = b.is_verified ? `<i data-lucide="badge-check" class="w-5 h-5 text-blue-500 fill-blue-50 ml-1.5 shrink-0"></i>` : '';
                const unreadDot = (b.unread > 0) ? `<span class="w-2.5 h-2.5 bg-red-500 rounded-full inline-block ml-2 animate-pulse shadow-sm shadow-red-200"></span>` : '';
                
                let aiBadge = '', cardClass = 'border-l-transparent';
                if (mode === 'browse' && b.score >= 10) {
                    cardClass = 'border-l-orange-500 bg-orange-50/20';
                    aiBadge = `<div class="flex items-center gap-1 text-[10px] font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full mb-2 w-fit tracking-wider"><i data-lucide="sparkles" class="w-3 h-3 animate-pulse"></i> SMART MATCH</div>`;
                }

                let primaryAction = '', secondaryActions = '';
                if(mode === 'browse') {
                    primaryAction = `<button onclick="sendConnect('${b.id}', this)" class="btn-primary text-xs w-full py-2">Connect +</button>`;
                    secondaryActions = `<button onclick="openReportModal('${b.id}', '${escapedName}')" class="text-[10px] text-gray-400 hover:text-red-500 flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i> Report</button>`;
                } else {
                    // Pass is_online status to openChat
                    primaryAction = `<button onclick="openChat('${b.id}', '${escapedName}', ${b.is_online})" class="btn-primary text-xs w-full py-2">Chat Now</button>`;
                    secondaryActions = `
                        <button onclick="disconnectUser('${b.id}', '${escapedName}')" class="text-[10px] text-red-400 hover:text-red-600 flex items-center gap-1"><i data-lucide="user-x" class="w-3 h-3"></i> Disconnect</button>
                        <button onclick="openReportModal('${b.id}', '${escapedName}')" class="text-[10px] text-gray-400 hover:text-red-500 flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i> Report</button>
                    `;
                }

                list.innerHTML += `
                <div class="card p-5 hover:shadow-md transition bg-white border-l-4 ${cardClass}">
                    <div class="flex justify-between items-start gap-4">
                        <div class="min-w-0 flex-1">
                            ${aiBadge}
                            <h3 onclick="openProfileModal(${index}, ${isConnected})" class="font-bold text-lg text-gray-900 flex items-center leading-tight cursor-pointer hover:text-orange-600 transition-colors">
                                ${b.name}${verifiedBadge}${unreadDot}
                            </h3>
                            <p class="text-sm text-gray-500 flex items-start gap-1.5 mt-1"><i data-lucide="map-pin" class="w-4 h-4 mt-0.5 shrink-0 text-gray-400"></i><span>${b.loc}</span></p>
                            <div class="mt-3 flex items-center gap-2">
                                <span class="pill bg-gray-100 text-gray-600 text-[9px] uppercase font-bold tracking-widest px-2 py-0.5">${b.type}</span>
                                <button onclick="openProfileModal(${index}, ${isConnected})" class="text-[10px] font-semibold text-blue-600 hover:underline">View Full Profile</button>
                            </div>
                        </div>
                        <div class="shrink-0 w-32 flex flex-col items-center">
                            ${primaryAction}
                            <div class="mt-3 flex flex-col items-center gap-2">
                                ${secondaryActions}
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            lucide.createIcons();
            checkNotifications();
        } catch(e) { 
            console.error(e);
            list.innerHTML = `<p class="text-red-500 col-span-3 text-center">Error: ${e.message}</p>`;
        }
    }

    
      function openProfileModal(index, isConnected) {
        // Look up data by index
        const data = currentConnectResults[index];
        if(!data) return;

        currentProfileData = data;
        
        // Populate UI
        document.getElementById('pd_name').innerText = data.name || 'Unknown';
        document.getElementById('pd_type').innerText = data.type || 'N/A';
        document.getElementById('pd_loc').innerText = data.loc || 'N/A';
        document.getElementById('pd_score').innerText = data.score || 'N/A';
        
        const vBox = document.getElementById('pd_verif_box');
        const vBadge = document.getElementById('pd_verified');
        
        if (data.is_verified) {
            vBox.classList.remove('hidden');
            vBadge.classList.remove('hidden');
            document.getElementById('pd_reg_num').innerText = data.reg_num || 'Verified';
            document.getElementById('pd_tax_id').innerText = data.tax_id || 'Not Provided';
        } else {
            vBox.classList.add('hidden');
            vBadge.classList.add('hidden');
        }

        const chatBtn = document.getElementById('pd_chat_btn');
        if (isConnected) {
            chatBtn.classList.remove('hidden');
            chatBtn.onclick = () => { closeProfileModal(); openChat(data.id, data.name); };
            chatBtn.innerText = "Send Message";
        } else {
            chatBtn.classList.add('hidden');
        }

        document.getElementById('profile_detail_modal').classList.remove('hidden');
        lucide.createIcons();
    }
    
    // ---- ACTIONS ----
    
    async function sendConnect(id, btn) {
        const originalText = btn.innerText;
        btn.innerText = "Sending...";
        btn.disabled = true;
        try {
            await call('/api/v1/connect', 'POST', { action: 'request', target_id: id });
            btn.innerText = "Request Sent";
            btn.className = "px-3 py-2 text-xs rounded bg-green-50 text-green-700 border border-green-200";
        } catch(e) {
            alert("Failed to send request.");
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function disconnectUser(id, name) {
        if(!confirm(`Are you sure you want to disconnect from ${name}?`)) return;
        
        try {
            await call('/api/v1/connect', 'POST', { action: 'disconnect', target_id: id });
            // Refresh list
            loadConnectHub('connections');
        } catch(e) {
            alert("Error disconnecting: " + e.message);
        }
    }

    // ---- ANALYTICS ----
    async function loadAnalytics() {
    try {
        const res = await call('/api/v1/analytics/dashboard');
        const container = document.getElementById('portal_content'); // Ensure you have this ID in your dashboard section
        if (!container) return;

        const type = res.type;
        const w = res.widgets;

        // --- RENDER BY TYPE ---

        if (type === 'Retailer') {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6">
                        <p class="text-xs font-bold text-gray-400 uppercase">Revenue Trend</p>
                        <p class="text-3xl font-black mt-2 text-orange-600">$${res.revenue || '5,700'}</p>
                        <div class="h-32 mt-4"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="card p-6 text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">Credit Score</p>
                        <h1 class="text-7xl font-black text-gray-900 mt-4">${w.score}</h1>
                        <span class="pill bg-green-100 text-green-700 mt-4 inline-block">TIER: GOLD</span>
                    </div>
                    <div class="card p-0 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-2 border-b font-bold text-xs">TOP PRODUCTS</div>
                        <table class="w-full text-sm">
                            ${w.table.map(p => `<tr class="border-b">
                                <td class="p-3">${p.item}</td>
                                <td class="p-3 text-right font-bold">$${p.value}</td>
                            </tr>`).join('')}
                        </table>
                    </div>
                </div>
            `;
            renderChart('mainChart', w.main_chart.labels, w.main_chart.values);
        }

        else if (type === 'FMCG') {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6 h-96">
                        <p class="text-xs font-bold text-gray-400 uppercase">Demand Heatmap [${res.country || 'Regional'}]</p>
                        <div class="mt-4 bg-gray-100 rounded-xl h-64 flex items-center justify-center italic text-gray-400">
                            Geospatial Visualization Area (Kenya/Nigeria Focus)
                        </div>
                    </div>
                    <div class="card p-6">
                        <p class="text-xs font-bold text-gray-400 uppercase">Stockout Frequency</p>
                        <div class="space-y-4 mt-6">
                            ${w.stockouts.map(s => `
                                <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                    <span class="font-bold">${s.item}</span>
                                    <span class="text-red-600 font-black">${s.freq} Stockout</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        else if (type === 'NGO') {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6 col-span-2">
                        <p class="text-xs font-bold text-gray-400 uppercase">Price Volatility Index (Staple Foods)</p>
                        <div class="h-64 mt-4"><canvas id="volatilityChart"></canvas></div>
                    </div>
                    <div class="card p-6">
                        <p class="text-xs font-bold text-gray-400 uppercase">Trade Disparity Alerts</p>
                        <div class="mt-6 space-y-3">
                            <p class="text-sm text-gray-600">Regional Disparity detected in <strong>Cardiff Region</strong>. Maize supply is 14% below expected threshold.</p>
                        </div>
                    </div>
                </div>
            `;
        }

        else if (type === 'Fintech') {
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div class="card p-6 text-center">
                        <p class="text-xs font-bold text-gray-400 uppercase">Eligible Retailers</p>
                        <h1 class="text-5xl font-black text-blue-600 mt-4">${w.eligibility}</h1>
                    </div>
                    <div class="card p-6 col-span-3">
                        <p class="text-xs font-bold text-gray-400 uppercase">Merchant Risk Tier Distribution</p>
                        <div class="h-48 mt-4"><canvas id="riskChart"></canvas></div>
                    </div>
                </div>
            `;
        }

        // Render Actionable Alerts (Common to all, but typed)
        const advisory = document.getElementById('advisory_row');
        advisory.innerHTML = res.alerts.map(a => `
            <div class="card p-4 border-l-4 ${a.cat === 'STOCK' ? 'border-red-500' : 'border-blue-500'} flex items-center gap-4">
                <i data-lucide="info" class="w-5 h-5 text-gray-400"></i>
                <p class="text-sm font-bold text-gray-700">${a.msg}</p>
            </div>
        `).join('');

        lucide.createIcons();
    } catch(e) { console.error(e); }
}

    
    // ---- ACTIONS ----
    async function sendConnect(id, btn) {
        const originalText = btn.innerText;
        btn.innerText = "Sending...";
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');

        try {
            await call('/api/v1/connect', 'POST', { action: 'request', target_id: id });
            btn.innerText = "Request Sent";
            btn.classList.remove('text-blue-600', 'border-blue-200');
            btn.classList.add('text-green-600', 'border-green-200', 'bg-green-50');
        } catch(e) {
            alert("Failed to send request. Please try again.");
            btn.innerText = originalText;
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }

    async function loadRequests() {
        const panel = document.getElementById('requests_panel');
        const list = document.getElementById('requests_list');
        panel.classList.toggle('hidden');
        
        try {
            const data = await call('/api/v1/connect?mode=requests');
            list.innerHTML = '';
            
            if(!data.results || data.results.length === 0) {
                document.getElementById('notif_badge').classList.add('hidden');
                list.innerHTML = '<p class="text-xs text-gray-500 italic">No pending requests.</p>'; 
                return; 
            }
            
            data.results.forEach(r => {
                list.innerHTML += `
                <div class="flex justify-between items-center bg-white p-3 rounded-xl border shadow-sm">
                    <span class="font-bold text-sm text-gray-900">${r.name}</span>
                    <div class="flex gap-2">
                        <button onclick="acceptRequest('${r.id}', this)" class="px-4 py-1.5 bg-green-600 text-white text-xs font-bold rounded-lg hover:bg-green-700 transition-colors">Accept</button>
                        <button onclick="declineRequest('${r.id}', this)" class="px-4 py-1.5 border border-red-200 text-red-600 text-xs font-bold rounded-lg hover:bg-red-50 transition-colors">Decline</button>
                    </div>
                </div>`;
            });
        } catch(e) { console.error(e); }
    }

    
    async function acceptRequest(connId, btn) {
        btn.innerText = "...";
        await call('/api/v1/connect', 'POST', { action: 'accept', connection_id: connId });
        btn.parentElement.remove();
        loadConnectHub('connections'); 
    }

    async function declineRequest(connId, btn) {
        const originalText = btn.innerText;
        btn.innerText = "...";
        btn.disabled = true;

        try {
            await call('/api/v1/connect', 'POST', { 
                action: 'decline', 
                connection_id: connId 
            });
            
            // Remove the card from the UI
            const card = btn.closest('.flex.justify-between');
            card.classList.add('opacity-0', 'scale-95', 'transition-all', 'duration-300');
            setTimeout(() => {
                card.remove();
                // Check if list is now empty to hide panel or show "No requests"
                const list = document.getElementById('requests_list');
                if (list.children.length === 0) {
                    list.innerHTML = '<p class="text-xs text-gray-500 italic">No pending requests.</p>';
                    document.getElementById('notif_badge').classList.add('hidden');
                }
            }, 300);

            // Refresh the badge count
            checkNotifications();
        } catch(e) {
            alert("Error declining request: " + e.message);
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function checkNotifications() {
        const data = await call('/api/v1/connect?mode=requests');
        const badge = document.getElementById('notif_badge');
        
        if(data.results && data.results.length > 0) {
            badge.classList.remove('hidden');
            badge.innerText = data.results.length; // Optional: Show count
        } else {
            // Explicitly hide if 0
            badge.classList.add('hidden');
        }
    }

    //Business card in connection hub
    let currentProfileData = null;

function openProfileModal(index, isConnected) {
        // Look up the clean data object from our global registry
        const data = currentConnectResults[index];
        if(!data) return;

        currentProfileData = data;
        document.getElementById('pd_name').innerText = data.name || 'Unknown';
        document.getElementById('pd_type').innerText = data.type || 'N/A';
        document.getElementById('pd_loc').innerText = data.loc || 'N/A';
        document.getElementById('pd_score').innerText = data.score || 'N/A';
        
        // Show/Hide verification details
        const vBox = document.getElementById('pd_verif_box');
        const vBadge = document.getElementById('pd_verified');
        if (data.is_verified) {
            vBox.classList.remove('hidden');
            vBadge.classList.remove('hidden');
            document.getElementById('pd_reg_num').innerText = data.reg_num || 'Verified';
            document.getElementById('pd_tax_id').innerText = data.tax_id || 'Not Provided';
        } else {
            vBox.classList.add('hidden');
            vBadge.classList.add('hidden');
        }

        // Handle Chat button logic
        const chatBtn = document.getElementById('pd_chat_btn');
        if (isConnected) {
            chatBtn.classList.remove('hidden');
            chatBtn.onclick = () => { closeProfileModal(); openChat(data.id, data.name); };
            chatBtn.innerText = "Send Message";
        } else {
            chatBtn.classList.add('hidden');
        }

        document.getElementById('profile_detail_modal').classList.remove('hidden');
        lucide.createIcons();
    }

    
function closeProfileModal() {
    document.getElementById('profile_detail_modal').classList.add('hidden');
}
    // ---- CHAT SYSTEM ----
    let currentChatPartner = null;
    let chatInterval = null;

    async function openChat(partnerId, partnerName, isOnline) {
    currentChatPartner = partnerId;
    document.getElementById('chat_partner_name').innerText = partnerName;

    // UPDATE THE UI STATUS
    const statusDot = document.getElementById('chat_status_dot');
    const statusText = document.getElementById('chat_status_text');
    
    if (isOnline) {
        statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
        statusText.innerText = "Online";
        statusText.className = "text-green-600 font-medium";
    } else {
        statusDot.className = "w-2 h-2 rounded-full bg-gray-400";
        statusText.innerText = "Offline";
        statusText.className = "text-gray-500";
    }

    document.getElementById('chat_modal').classList.remove('hidden');
    
    // Notify backend that messages are being read
    try {
        await call(`/api/v1/chat/read?partner_id=${partnerId}`, 'POST');
    } catch(e) { console.warn("Failed to mark as read"); }

    loadMessages();
    chatInterval = setInterval(loadMessages, 3000);
}

    function closeChat() {
        document.getElementById('chat_modal').classList.add('hidden');
        clearInterval(chatInterval);
        currentChatPartner = null;
    }

    async function loadMessages() {
        if(!currentChatPartner) return;
        const box = document.getElementById('chat_box');
        const data = await call(`/api/v1/chat?partner_id=${currentChatPartner}`);
        const isAtBottom = box.scrollHeight - box.scrollTop === box.clientHeight;
        box.innerHTML = '';
        data.messages.forEach(m => {
            const align = m.is_me ? "self-end bg-orange-600 text-white" : "self-start bg-gray-200 text-gray-800";
            box.innerHTML += `
            <div class="flex flex-col ${m.is_me ? 'items-end' : 'items-start'}">
                <div class="px-4 py-2 rounded-2xl max-w-[80%] text-sm ${align}">
                    ${m.text}
                </div>
                <span class="text-[10px] text-gray-400 mt-1">${m.time}</span>
            </div>`;
        });
        if(isAtBottom) box.scrollTop = box.scrollHeight;
    }

    async function sendMessage() {
        const input = document.getElementById('chat_input');
        const text = input.value.trim();
        if(!text) return;
        input.value = ''; 
        await call('/api/v1/chat', 'POST', { partner_id: currentChatPartner, content: text });
        loadMessages(); 
    }
    document.getElementById('chat_input').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    
    //report modal
    let currentReportTarget = null;

function openReportModal(id, name) {
    currentReportTarget = id;
    document.getElementById('report_target_name').innerText = name;
    document.getElementById('report_modal').classList.remove('hidden');
}

function closeReportModal() {
    document.getElementById('report_modal').classList.add('hidden');
    document.getElementById('report_details').value = '';
}

async function submitReport() {
    const category = document.getElementById('report_category').value;
    const details = document.getElementById('report_details').value;
    const btn = document.getElementById('btn_submit_report');

    if(!details.trim()) return alert("Please provide details.");

    btn.disabled = true; btn.innerText = "Sending...";
    try {
        await call('/api/v1/report', 'POST', {
            target_id: currentReportTarget,
            category: category,
            details: details
        });
        alert("Report submitted. Our team will review this and take the appropriate action. We may reach out to you for more information or feedback.");
        closeReportModal();
    } catch(e) {
        alert("Failed to send report: " + e.message);
    } finally {
        btn.disabled = false; btn.innerText = "Submit Report";
    }
}

    // ---- MODAL CONTROLS ----
    function openModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.remove('hidden');
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
        }
    }

    function closeModal(id) {
        const modal = document.getElementById(id);
        if (modal) {
            modal.classList.add('hidden');
            // Restore body scrolling
            document.body.style.overflow = 'auto';
        }
    }

    // Close modals if user clicks the dark background
    window.onclick = function(event) {
        if (event.target.classList.contains('fixed') && event.target.classList.contains('inset-0')) {
            event.target.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
    };
    
    // ---- VERIFICATION ----
    async function loadVerification() {
        const form = document.getElementById('verifForm');
        const statusCard = document.getElementById('verif_status_card');
        const editBtn = document.getElementById('btn_edit_verif');

        try {
            const data = await call('/api/v1/verification');
            
            if(data.reg_num) document.getElementById('v_reg_num').value = data.reg_num;
            if(data.tax_id) document.getElementById('v_tax_id').value = data.tax_id;
            
            editBtn.classList.remove('hidden'); 

            if (data.status === "NOT_SUBMITTED") {
                statusCard.classList.add('hidden'); form.classList.remove('hidden');
            } 
            else if (data.status === "PENDING") {
                form.classList.add('hidden'); statusCard.classList.remove('hidden');
                statusCard.className = "mb-6 p-5 rounded-lg border flex flex-col gap-3 bg-blue-50 border-blue-200 text-blue-900";
                document.getElementById('verif_icon').parentElement.className = "w-10 h-10 rounded-full flex items-center justify-center bg-blue-200";
                document.getElementById('verif_icon').innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 text-blue-700 animate-spin"></i>';
                document.getElementById('verif_title').innerText = "Application Under Review";
                document.getElementById('verif_desc').innerText = "You can update your details if needed.";
            }
            else if (data.status === "APPROVED") {
                form.classList.add('hidden'); statusCard.classList.remove('hidden');
                statusCard.className = "mb-6 p-5 rounded-lg border flex flex-col gap-3 bg-green-50 border-green-200 text-green-900";
                document.getElementById('verif_icon').parentElement.className = "w-10 h-10 rounded-full flex items-center justify-center bg-green-200";
                document.getElementById('verif_icon').innerHTML = '<i data-lucide="check" class="w-5 h-5 text-green-700"></i>';
                document.getElementById('verif_title').innerText = "Business Verified";
                document.getElementById('verif_desc').innerText = "Your business is verified. Click edit to update details.";
            }
            else if (data.status === "REJECTED") {
                form.classList.remove('hidden'); statusCard.classList.remove('hidden');
                statusCard.className = "mb-6 p-5 rounded-lg border flex flex-col gap-3 bg-red-50 border-red-200 text-red-900";
                document.getElementById('verif_icon').parentElement.className = "w-10 h-10 rounded-full flex items-center justify-center bg-red-200";
                document.getElementById('verif_icon').innerHTML = '<i data-lucide="x" class="w-5 h-5 text-red-700"></i>';
                document.getElementById('verif_title').innerText = "Action Required";
                document.getElementById('verif_desc').innerText = "Please correct your details and resubmit.";
                editBtn.classList.add('hidden');
            }
            lucide.createIcons();
        } catch(e) { console.error(e); }
    }

    window.enableVerifEdit = function() {
        document.getElementById('verifForm').classList.remove('hidden');
        document.getElementById('verif_status_card').classList.add('hidden');
    }

    document.getElementById('verifForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const payload = {
            business_name: document.getElementById('v_biz_name').value,
            business_location: document.getElementById('v_biz_loc').value,
            business_type: document.getElementById('v_biz_type').value,
            registration_number: document.getElementById('v_reg_num').value,
            tax_id: document.getElementById('v_tax_id').value || null
        };
        const btn = e.target.querySelector('button');
        const oldText = btn.innerText;
        btn.innerText = "Submitting..."; btn.disabled = true;
        try {
            const res = await call('/api/v1/verification', 'POST', payload);
        if (res.auto_approved) {
            alert("Success! Your Retailer account has been auto-verified for the Free Community Tier. You now have full access.");
        } else {
            alert("Application Submitted! Your status is now Pending.");
        };
            await loadVerification();
            if (res.auto_approved) switchView('dashboard');
    } catch(err) { alert("Error: " + err.message); }
      finally {
            // Reset the button state NO MATTER WHAT happens
            btn.innerText = oldText; 
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    });

    async function loadTracking() {
    try {
        const data = await call('/api/v1/verification');
        
        // 1. Map DOM Elements
        const s1 = document.getElementById('step1_icon'), 
              s2 = document.getElementById('step2_icon'), 
              s3 = document.getElementById('step3_icon');
        const d1 = document.getElementById('step1_date'), 
              d2 = document.getElementById('step2_date'), 
              d3 = document.getElementById('step3_date');
        const t2 = document.getElementById('step2_title'), 
              t3 = document.getElementById('step3_title'), 
              desc2 = document.getElementById('step2_desc');

        // 2. Handle Dynamic Labels (Retailer vs Business)
        if (data.type === 'Retailer') {
            if(t2) t2.innerText = "Secondary Validation";
            if(desc2) desc2.innerText = "Automated system checks and community tier alignment.";
            if(t3) t3.innerText = "Access Completed";
        } else {
            if(t2) t2.innerText = "Compliance Review";
            if(desc2) desc2.innerText = "Our team is verifying your registration and tax credentials.";
            if(t3) t3.innerText = "Verification Approved";
        }

        // 3. Reset Icons to default state
        [s1, s2, s3].forEach(el => {
            if(el) {
                el.className = "w-10 h-10 rounded-full bg-gray-200 border-4 border-white flex items-center justify-center text-white z-10";
                el.innerHTML = '<i data-lucide="check" class="w-5 h-5"></i>'; // Default icon
            }
        });

        // 4. Update UI based on Status
        if (data.status !== "NOT_SUBMITTED") {
            // Milestone 1: Always Green
            s1.className = "w-10 h-10 rounded-full bg-green-500 border-4 border-white flex items-center justify-center text-white z-10";
            if (data.submitted_at) {
                d1.innerText = "Submitted on " + new Date(data.submitted_at).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
            }

            // Milestone 2 & 3: Conditional
            if (data.status === "PENDING") {
                s2.className = "w-10 h-10 rounded-full bg-blue-500 border-4 border-white flex items-center justify-center text-white z-10";
                s2.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>';
            } 
            else if (data.status === "APPROVED") {
                // Both 2 and 3 become green
                s2.className = "w-10 h-10 rounded-full bg-green-500 border-4 border-white flex items-center justify-center text-white z-10";
                s3.className = "w-10 h-10 rounded-full bg-green-500 border-4 border-white flex items-center justify-center text-white z-10";
                
                if (data.reviewed_at) {
                    const reviewDate = new Date(data.reviewed_at).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
                    if(d2) d2.innerText = (data.type === 'Retailer' ? "Validated on " : "Reviewed on ") + reviewDate;
                    if(d3) d3.innerText = "Approved on " + reviewDate;
                }
            }
            else if (data.status === "REJECTED") {
                s2.className = "w-10 h-10 rounded-full bg-red-500 border-4 border-white flex items-center justify-center text-white z-10";
                s2.innerHTML = '<i data-lucide="x" class="w-5 h-5"></i>';
                if(d2) d2.innerText = "Rejected";
                document.getElementById('track_action')?.classList.remove('hidden');
            }
        }
        
        document.getElementById('track_id').innerText = data.reg_num || "VER-";
        lucide.createIcons();
    } catch(e) { 
        console.error("LoadTracking error:", e); 
    }
}

    
    // ---- INIT ----
    async function init() {
        lucide.createIcons();
        try {
            const me = await call('/api/v1/me');
            const name = me?.user?.name || '';
            const email = me?.user?.email || 'Unknown';
            
            // Save GLOBAL State
            currentUserType = me?.user?.type || 'Retailer';
            currentVerifStatus = me?.user?.status || 'NOT_SUBMITTED';

            let display = name ? name : (email.split('@')[0]);
            document.getElementById('welcomeName').innerText = display;
            document.getElementById('email').innerText = email;
            document.getElementById('status').innerText = 'Signed in';
        } catch(e) {
            window.location.href = `${SIGNIN_PAGE}?continue=${encodeURIComponent(location.href)}`;
        }
    }

    // ---- MISC LISTENERS ----
    const allCountries = ["Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (DRC)","Congo (Republic)","Costa Rica","Cote d'Ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Korea (North)","Korea (South)","Kosovo","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Macedonia","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"];
    
    function initCountries(selectId) {
        const select = document.getElementById(selectId);
        if(!select) return;
        select.innerHTML = '<option value="">Select Country</option>';
        allCountries.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            select.appendChild(opt);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        initCountries('v_biz_loc');
        initCountries('filter_loc'); // Populate the Filter dropdown too!
        
        const langBtn = document.getElementById("lang-btn");
        const langMenu = document.getElementById("lang-menu");
        if(langBtn && langMenu) {
            langBtn.addEventListener("click", (e) => { e.stopPropagation(); langMenu.classList.toggle("hidden"); });
            document.addEventListener("click", (e) => { if(!langBtn.contains(e.target) && !langMenu.contains(e.target)) langMenu.classList.add("hidden"); });
        }
    });

    document.getElementById('copyBtn')?.addEventListener('click', async () => {
      const email = document.getElementById('email')?.innerText?.trim();
      if (!email || email === '—') return;
      try { await navigator.clipboard.writeText(email); const btn = document.getElementById('copyBtn'); const old = btn.innerText; btn.innerText = 'Copied'; setTimeout(()=> btn.innerText = old, 1200); } catch {}
    });

    document.getElementById('logoutBtn')?.addEventListener('click', () => {
        localStorage.removeItem('token');
        window.location.href = SIGNIN_PAGE;
    });

    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', init);

  
  </script>
</body>
</html>
