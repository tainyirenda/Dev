<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  
  <title>Afro Ubuntu • Account Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- CSS / Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  
  <!-- Chart.js for Dashboard -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Google Translate Logic -->
  <script type="text/javascript">
  function fireGoogleTranslateEvent(el, eventName) { try { if (document.createEvent) { var event = document.createEvent("HTMLEvents"); event.initEvent(eventName, true, true); el.dispatchEvent(event); } else { el.dispatchEvent(new Event(eventName)); } } catch (e) {} }
  function setGoogleTransCookie(lang) { document.cookie = "googtrans=/en/" + lang + ";path=/;"; document.cookie = "googtrans=/en/" + lang + ";path=/;domain=" + window.location.hostname + ";"; }
  window.setLanguage = function(lang) { 
    function apply() { const c = document.querySelector(".goog-te-combo"); if (!c) return false; c.value = lang; fireGoogleTranslateEvent(c, "change"); try { localStorage.setItem("selectedLang", lang); } catch (e) {} return true; } 
    if (apply()) return; 
    const obs = new MutationObserver(() => { if (apply()) obs.disconnect(); }); 
    obs.observe(document.body, { childList: true, subtree: true }); 
    setGoogleTransCookie(lang); 
    setTimeout(() => window.location.reload(), 300); 
  };
  function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'en', includedLanguages: 'en,sw,sn,ny,yo,af,xh,zu,fr,ha,pcm,nd', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element'); }
  </script>
  <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit" defer></script>
  
  <style>
    :root{ --au-ink:#111827; --au-stone:#6b7280; --au-line:#e5e7eb; --au-surface:#f8fafc; --au-accent:#ea580c; --au-green:#16a34a; }
    body{ font-family:Inter, sans-serif; background:var(--au-surface); color:var(--au-ink); }
    .card { background: #fff; border:1px solid var(--au-line); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,0.05); }
    .iconwrap { width:48px; height:48px; border-radius:12px; display:grid; place-items:center; background:#f3f4f6; color:var(--au-ink); }
    .btn-outline { border:1px solid var(--au-line); border-radius:10px; padding:8px 14px; background:#fff; font-weight:500; transition:all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;}
    .btn-outline:hover { background:#f9fafb; border-color:#d1d5db; }
    .btn-primary { background: var(--au-ink); color: #fff; border-radius:10px; padding:10px 14px; font-weight:600; transition:opacity 0.2s; }
    .btn-primary:hover { opacity: 0.9; }
    .pill { padding:.2rem .6rem; border-radius:99px; font-size:.75rem; font-weight:600; }
    .link { text-decoration: underline; text-decoration-color: #d1d5db; text-underline-offset: 3px; cursor: pointer; }
    .link:hover { color: var(--au-accent); text-decoration-color: var(--au-accent); }
    
    .view-section { display: none; animation: fadeIn 0.3s ease-out; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    @keyframes pulse-orange { 0%, 100% { color: var(--au-accent); opacity: 1; } 50% { opacity: .6; } }
    .animate-ai { animation: pulse-orange 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    #google_translate_element { display: none !important; }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="bg-white border-b border-[color:var(--au-line)] sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="switchView('hub')">
        <div class="w-9 h-9 rounded-lg bg-[color:var(--au-ink)] grid place-items-center text-white text-[11px] font-bold">AUTN</div>
        <div class="hidden sm:block">
          <p class="text-sm font-semibold text-[color:var(--au-ink)]">Afro Ubuntu TradeNet</p>
          <p class="text-xs text-[color:var(--au-stone)]">Rooted in Africa, connected to the world</p>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <div class="relative group">
           <button id="lang-btn" class="btn-outline text-xs">
             <i data-lucide="globe" class="w-3 h-3"></i> Language
           </button>
           <div id="lang-menu" class="absolute right-0 mt-2 w-40 bg-white border border-gray-200 rounded-xl shadow-xl hidden p-1 z-50 max-h-60 overflow-y-auto">
             <button onclick="window.setLanguage('en')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">English</button>
             <button onclick="window.setLanguage('sw')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Swahili</button>
             <button onclick="window.setLanguage('fr')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">French</button>
             <button onclick="window.setLanguage('ha')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Hausa</button>
             <button onclick="window.setLanguage('pcm')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Pidgin</button>
             <button onclick="window.setLanguage('nd')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Ndebele</button>
             <button onclick="window.setLanguage('yo')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Yoruba</button>
             <button onclick="window.setLanguage('zu')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Zulu</button>
             <button onclick="window.setLanguage('xh')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Xhosa</button>
             <button onclick="window.setLanguage('sn')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Shona</button>
             <button onclick="window.setLanguage('ny')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Nyanja</button>
             <button onclick="window.setLanguage('af')" class="block w-full text-left px-3 py-2 text-xs hover:bg-gray-50 rounded">Afrikaans</button>
           </div>
        </div>
        <a href="index.html" class="btn-outline text-xs text-gray-700 hover:text-black">Home</a>
        <button id="logoutBtn" class="btn-outline text-xs text-red-600 border-red-100 hover:bg-red-50">Log out</button>
      </nav>
    </div>
    <div class="h-[3px] bg-gradient-to-r from-[color:var(--au-accent)] to-[color:var(--au-ink)]"></div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-8">

    <!-- VIEW 1: HUB -->
    <section id="view-hub" class="view-section active">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-8">
        <div>
          <h1 class="text-3xl font-extrabold text-[color:var(--au-ink)]">Your account</h1>
          <p class="text-[15px] text-[color:var(--au-stone)]">Welcome back, <span id="welcomeName" class="font-semibold text-[color:var(--au-ink)]">User</span></p>
        </div>
        <span class="pill bg-green-100 text-green-700" id="status">Signed in</span>
      </div>

      <div class="card p-4 flex items-center justify-between gap-3 mb-8">
        <div class="flex items-center gap-3">
          <div class="iconwrap"><i data-lucide="user" class="w-5 h-5"></i></div>
          <div class="min-w-0">
            <p class="text-xs text-[color:var(--au-stone)] uppercase tracking-wider font-semibold">Signed in as</p>
            <p class="text-base font-medium truncate" id="email">—</p>
          </div>
        </div>
        <button class="btn-outline text-xs" id="copyBtn">Copy</button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
        <button onclick="switchView('dashboard')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-purple-100 group-hover:text-purple-600 transition-colors"><i data-lucide="layout-dashboard" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Dashboard</h3><p class="mt-1 text-sm text-gray-500">Usage, APIs and KPIs.</p></div></div></button>
        <button onclick="switchView('insights')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors"><i data-lucide="line-chart" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Insights</h3><p class="mt-1 text-sm text-gray-500">Analysis & alerts.</p></div></div></button>
        <button onclick="switchView('connect')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-orange-100 group-hover:text-orange-600 transition-colors"><i data-lucide="messages-square" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Connect Hub</h3><p class="mt-1 text-sm text-gray-500">Partners & Smart matching.</p></div></div></button>
        <button onclick="switchView('verification')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-green-100 group-hover:text-green-600 transition-colors"><i data-lucide="badge-check" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Verification</h3><p class="mt-1 text-sm text-gray-500">Confirm business details.</p></div></div></button>
        <button onclick="switchView('track')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-teal-100 group-hover:text-teal-600 transition-colors"><i data-lucide="receipt-text" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Track Application</h3><p class="mt-1 text-sm text-gray-500">Review status.</p></div></div></button>
        <button onclick="switchView('billing')" class="card p-6 text-left hover:shadow-md transition-all group w-full"><div class="flex items-start gap-4"><div class="iconwrap group-hover:bg-blue-100 group-hover:text-blue-600 transition-colors"><i data-lucide="credit-card" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-900">Billing & Plans</h3><p class="mt-1 text-sm text-gray-500">Manage plans.</p></div></div></button>
      </div>

      <div class="mt-8 card p-5 bg-gray-50 border-none flex items-start gap-3">
        <i data-lucide="info" class="w-5 h-5 text-gray-400 mt-0.5"></i>
        <p class="text-sm text-gray-500">Need help? Email <a class="link" href="mailto:dev@afroubuntutrade.co.uk">dev@afroubuntutrade.co.uk</a>.</p>
      </div>
    </section>

    <!-- VIEW 2: DASHBOARD -->
    <section id="view-dashboard" class="view-section">
      <div class="flex items-center gap-4 mb-6">
        <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
        <h1 class="text-2xl font-bold text-[color:var(--au-ink)]">Analytics Dashboard</h1>
      </div>
      <div id="portal_content" class="space-y-6"></div>
    </section>

    <!-- VIEW 3: INSIGHTS -->
    <section id="view-insights" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back to Hub</button>
            <h1 class="text-2xl font-bold">Insights & Alerts</h1>
        </div>
        <div id="advisory_row" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </section>

    <!-- VIEW 4: CONNECT HUB -->
    <section id="view-connect" class="view-section relative">
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-4">
                <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
                <h1 class="text-2xl font-bold">Connect Hub</h1>
            </div>
            <div class="relative cursor-pointer" onclick="loadRequests()">
                <i data-lucide="bell" class="w-6 h-6 text-gray-600"></i>
                <span id="notif_badge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
            </div>
        </div>

        <div class="flex flex-wrap gap-3 mb-6 bg-white p-3 rounded-xl border shadow-sm">
            <select id="filter_type" onchange="loadConnectHub('browse')" class="text-sm border-gray-200 rounded-lg px-3 py-2 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-orange-500">
                <option value="">All Types</option>
                <option value="Retailer">Retailer</option>
                <option value="FMCG">FMCG</option>
                <option value="NGO">NGO</option>
                <option value="Development Partner">Development Partner</option>
                <option value="Fintech">Fintech</option>
                <option value="Micro-Lender">Micro-Lender</option>
            </select>
            <select id="filter_loc" onchange="loadConnectHub('browse')" class="text-sm border-gray-200 rounded-lg px-3 py-2 bg-gray-50 focus:outline-none focus:ring-1 focus:ring-orange-500 w-48">
                <option value="">All Locations</option>
            </select>
            <div class="relative flex-1 min-w-[200px]">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"></i>
                <input type="text" id="filter_search" oninput="debouncedSearch()" placeholder="Search names..." class="w-full pl-10 pr-4 py-2 text-sm border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-1 focus:ring-orange-500 outline-none transition-all">
            </div>
            <div class="flex gap-4 ml-auto border-l pl-4">
                <button onclick="loadConnectHub('browse')" id="tab-browse" class="text-sm font-semibold text-orange-600">Explore</button>
                <button onclick="loadConnectHub('connections')" id="tab-network" class="text-sm text-gray-500 hover:text-gray-700">My Network</button>
            </div>
        </div>

        <div id="requests_panel" class="hidden mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h3 class="text-sm font-bold text-yellow-800 mb-3">Pending Requests</h3>
            <div id="requests_list" class="space-y-2 flex flex-col gap-2"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5" id="connect_list"></div>
        
        <!-- CHAT MODAL -->
        <div id="chat_modal" class="fixed inset-0 z-50 hidden bg-black/50 flex items-end sm:items-center justify-center p-4">
             <div class="bg-white w-full sm:w-[450px] h-[80vh] sm:h-[600px] rounded-2xl shadow-2xl flex flex-col overflow-hidden">
                <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                    <div><h3 class="font-bold text-gray-800" id="chat_partner_name">Name</h3><p class="text-xs text-green-600 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span> Online</p></div>
                    <button onclick="closeChat()" class="p-2 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="bg-amber-50 p-3 text-[9px] text-amber-800 leading-tight border-b border-amber-100">
                    <i data-lucide="shield-alert" class="w-3 h-3 inline-block mr-1"></i>
                    Shared information must be kept confidential. We are not liable for decisions between parties but act on reported behavior. See policies for more.
                </div>
                <div id="chat_box" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
                <div class="p-3 border-t bg-gray-50 flex gap-2">
                    <input type="text" id="chat_input" placeholder="Type a message..." class="flex-1 border rounded-full px-4 py-2 outline-none focus:border-orange-500">
                    <button onclick="sendMessage()" class="bg-orange-600 text-white p-2 rounded-full hover:bg-orange-700"><i data-lucide="send" class="w-5 h-5"></i></button>
                </div>
            </div>
        </div>

        <!-- PROFILE MODAL -->
        <div id="profile_detail_modal" class="fixed inset-0 z-[70] hidden bg-black/60 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden flex flex-col">
                <div class="bg-gray-50 px-6 py-4 border-b flex justify-between items-center">
                    <h3 class="font-bold text-gray-900">Business Profile</h3>
                    <button onclick="closeProfileModal()" class="p-1 hover:bg-gray-200 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
                <div class="p-6 space-y-5 overflow-y-auto max-h-[70vh]">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Business Name</label>
                        <div class="flex items-center gap-2 mt-1">
                            <h2 id="pd_name" class="text-2xl font-extrabold text-gray-900 leading-tight">--</h2>
                            <span id="pd_verified" class="hidden"><i data-lucide="badge-check" class="w-6 h-6 text-blue-500 fill-blue-50"></i></span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Sector</label><p id="pd_type" class="font-semibold text-indigo-600 mt-1">--</p></div>
                        <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Match Score</label><p id="pd_score" class="font-semibold text-orange-600 mt-1">--</p></div>
                    </div>
                    <div><label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Address / Location</label><p id="pd_loc" class="text-gray-700 mt-1 text-base">--</p></div>
                    <div id="pd_verif_box" class="p-4 bg-blue-50 rounded-xl border border-blue-100 hidden">
                        <label class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Verification Details</label>
                        <div class="mt-2 text-sm text-blue-900 space-y-1">
                            <p><strong>Registration:</strong> <span id="pd_reg_num">--</span></p>
                            <p><strong>Tax ID:</strong> <span id="pd_tax_id">--</span></p>
                        </div>
                    </div>
                </div>
                <div class="p-6 bg-gray-50 border-t flex gap-3">
                     <button id="pd_chat_btn" class="flex-1 btn-primary text-sm py-2.5">Chat Now</button>
                     <button onclick="closeProfileModal()" class="flex-1 btn-outline text-sm py-2.5">Close</button>
                </div>
            </div>
        </div>
    </section>

    <!-- VIEW 5: VERIFICATION -->
    <section id="view-verification" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
            <h1 class="text-2xl font-bold">Business Verification</h1>
        </div>
        <div class="card p-8 max-w-2xl mx-auto">
            <div id="verif_status_card" class="hidden mb-6 p-5 rounded-lg border flex flex-col gap-3">
                <div class="flex items-center gap-3">
                    <div id="verif_icon_box" class="w-10 h-10 rounded-full flex items-center justify-center">
                        <i id="verif_icon" data-lucide="info" class="w-5 h-5"></i>
                    </div>
                    <div><h3 class="font-bold text-lg" id="verif_title">Status</h3><p class="text-sm" id="verif_desc">Checking...</p></div>
                </div>
                <button id="btn_edit_verif" onclick="enableVerifEdit()" class="btn-outline text-xs self-end hidden">Edit & Resubmit</button>
            </div>
            <form id="verifForm" class="space-y-4">
                <div><label class="block text-sm font-medium">Business Name</label><input type="text" id="v_biz_name" class="mt-1 block w-full rounded-md border p-3" required></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-sm font-medium">Location</label><select id="v_biz_loc" class="mt-1 block w-full rounded-md border p-3 bg-white" required><option value="">Select Country</option></select></div>
                    <div><label class="block text-sm font-medium">Type</label><select id="v_biz_type" class="mt-1 block w-full rounded-md border p-3 bg-white" required><option value="">Select Type</option><option value="FMCG">FMCG / Supplier</option><option value="Fintech">Fintech / Bank</option><option value="NGO">NGO / Aid</option></select></div>
                </div>
                <div><label class="block text-sm font-medium">Registration Number</label><input type="text" id="v_reg_num" class="mt-1 block w-full rounded-md border p-3" required></div>
                <div><label class="block text-sm font-medium">Tax ID (Optional)</label><input type="text" id="v_tax_id" class="mt-1 block w-full rounded-md border p-3"></div>
                <button type="submit" class="w-full btn-primary mt-4">Submit Application</button>
            </form>
        </div>
    </section>

    <!-- VIEW 6: TRACK APPLICATION -->
    <section id="view-track" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
            <h1 class="text-2xl font-bold">Track Status</h1>
        </div>
        <div class="card p-8 max-w-3xl mx-auto text-center">
            <h2 class="text-xl font-bold mb-4">Application Progress</h2>
            <div id="track_id" class="text-xs text-gray-400 mb-8 uppercase tracking-widest">Checking...</div>
            <div class="flex justify-around items-center relative">
                <div class="absolute w-full h-0.5 bg-gray-200 -z-10"></div>
                <div id="step1_icon" class="w-10 h-10 rounded-full bg-gray-200 border-4 border-white flex items-center justify-center text-white"><i data-lucide="check" class="w-5 h-5"></i></div>
                <div id="step2_icon" class="w-10 h-10 rounded-full bg-gray-200 border-4 border-white flex items-center justify-center text-white"><i data-lucide="loader-2" class="w-5 h-5"></i></div>
                <div id="step3_icon" class="w-10 h-10 rounded-full bg-gray-200 border-4 border-white flex items-center justify-center text-white"><i data-lucide="award" class="w-5 h-5"></i></div>
            </div>
            <div id="track_action" class="mt-10 hidden"><button onclick="switchView('verification')" class="btn-outline text-xs">Update Info</button></div>
        </div>
    </section>

    <!-- VIEW 7: BILLING -->
    <section id="view-billing" class="view-section">
        <div class="flex items-center gap-4 mb-6">
            <button onclick="switchView('hub')" class="btn-outline flex items-center gap-2 text-sm text-gray-600"><i data-lucide="arrow-left" class="w-4 h-4"></i> Back</button>
            <h1 class="text-2xl font-bold">Billing & Plans</h1>
        </div>
        <div class="space-y-10">
            <div class="card overflow-hidden">
                <div class="bg-indigo-50 px-6 py-4 border-b border-indigo-100 flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center"><i data-lucide="store" class="w-4 h-4"></i></div><div><h3 class="font-bold text-indigo-800">Retailers & Traders</h3><p class="text-xs text-indigo-600">Free forever tools.</p></div></div>
                <table class="w-full text-sm text-left"><tbody class="divide-y divide-gray-100"><tr><td class="px-6 py-4 font-bold">Community</td><td class="px-6 py-4 text-green-600 font-bold">Free Forever</td><td class="px-6 py-4 text-gray-500">Analytics, Connect Hub, and WhatsApp.</td><td class="px-6 py-4 text-right"><span class="pill bg-indigo-100 text-indigo-700">Included</span></td></tr></tbody></table>
            </div>
        </div>
    </section>

    <!-- RESTRICTED VIEW -->
    <section id="view-restricted" class="view-section text-center py-16">
        <div class="w-20 h-20 rounded-full bg-red-50 text-red-600 mx-auto flex items-center justify-center mb-6"><i data-lucide="lock" class="w-10 h-10"></i></div>
        <h2 class="text-2xl font-bold">Verification Required</h2>
        <p class="text-gray-500 mt-2">Approved verification is required for this feature.</p>
        <div class="mt-8 flex justify-center gap-4"><button onclick="switchView('verification')" class="btn-primary">Go to Verification</button></div>
    </section>
    
  </main>

  <!-- Modals -->
  <div id="report_modal" class="fixed inset-0 z-[60] hidden bg-black/60 flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-1">Report User</h3>
        <select id="report_category" class="w-full border rounded-lg p-2 text-sm mb-4 bg-gray-50"><option value="ethics">Ethics/Behavior</option><option value="privacy">Privacy/Data</option><option value="legal">Legal</option></select>
        <textarea id="report_details" placeholder="Incident details..." class="w-full border rounded-lg p-2 text-sm h-24 mb-6 outline-none focus:ring-1 focus:ring-orange-500"></textarea>
        <div class="flex gap-3"><button onclick="closeReportModal()" class="flex-1 btn-outline text-xs">Cancel</button><button onclick="submitReport()" id="btn_submit_report" class="flex-1 bg-red-600 text-white rounded-lg text-xs font-bold py-2 hover:bg-red-700">Submit</button></div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://afroauth-api-g7cqa9cvc4amhqh2.uksouth-01.azurewebsites.net';
    const SIGNIN_PAGE = 'api-connection.html';

    let currentUserType = 'Retailer';
    let currentVerifStatus = 'NOT_SUBMITTED';
    let currentConnectResults = [];
    let searchTimeout;

    async function call(path, method='GET', body=null) {
        const t = localStorage.getItem('token');
        if(!t) throw new Error("No token");
        const opts = { method, headers: { 'Authorization': 'Bearer ' + t, 'Content-Type': 'application/json' } };
        if(body) opts.body = JSON.stringify(body);
        const res = await fetch(API_BASE + path, opts);
        const data = await res.json().catch(()=>null);
        if (res.status === 403) throw new Error("VERIFICATION_REQUIRED");
        if (!res.ok) throw new Error((data && (data.error||data.message)) || 'HTTP ' + res.status);
        return data;
    }

    async function switchView(viewName) {
        if (['dashboard', 'insights', 'connect'].includes(viewName)) {
            if (currentUserType !== 'Retailer' && currentVerifStatus !== 'APPROVED') { viewName = 'restricted'; } 
            else { try { await call('/api/v1/analytics/dashboard'); } catch (e) { if (e.message.includes('VERIFICATION_REQUIRED')) viewName = 'restricted'; } }
        }
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const target = document.getElementById(`view-${viewName}`);
        if(target) target.classList.add('active');
        lucide.createIcons();
        window.scrollTo(0, 0);
        if(viewName === 'connect') loadConnectHub();
        if(viewName === 'dashboard' || viewName === 'insights') loadAnalytics();
        if(viewName === 'verification') loadVerification();
        if(viewName === 'track') loadTracking();
    }

    function debouncedSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => { loadConnectHub(); }, 400);
    }

    async function loadConnectHub(mode = 'browse') {
        const list = document.getElementById('connect_list');
        document.getElementById('tab-browse').className = mode==='browse' ? "text-sm font-semibold text-orange-600 border-b-2 border-orange-500 pb-2" : "text-sm text-gray-500 hover:text-gray-700 pb-2";
        document.getElementById('tab-network').className = mode==='connections' ? "text-sm font-semibold text-orange-600 border-b-2 border-orange-500 pb-2" : "text-sm text-gray-500 hover:text-gray-700 pb-2";

        const search = document.getElementById('filter_search')?.value || '';
        const type = document.getElementById('filter_type')?.value || '';
        const loc = document.getElementById('filter_loc')?.value || '';

        try {
            let url = `/api/v1/connect?mode=${mode}`;
            if(search) url += `&search=${encodeURIComponent(search)}`;
            if(type) url += `&type=${encodeURIComponent(type)}`;
            if(loc) url += `&loc=${encodeURIComponent(loc)}`;

            const data = await call(url);
            list.innerHTML = '';
            if(!data.results || data.results.length === 0) { list.innerHTML = '<p class="text-gray-400 col-span-3 text-center py-20 italic">No matches found.</p>'; return; }

            currentConnectResults = data.results;
            const isConnected = (mode === 'connections');

            currentConnectResults.forEach((b, index) => {
                const escapedName = (b.name || '').replace(/'/g, "\\'"); 
                const verifiedBadge = b.is_verified ? `<i data-lucide="badge-check" class="w-4 h-4 text-blue-500 fill-blue-50 ml-1.5 shrink-0"></i>` : '';
                const unreadDot = b.unread > 0 ? `<span class="w-2.5 h-2.5 bg-red-500 rounded-full inline-block ml-2 animate-pulse shadow-sm shadow-red-200"></span>` : '';
                
                let aiBadge = '', cardClass = 'border-l-transparent';
                if (mode === 'browse' && b.score >= 10) {
                    cardClass = 'border-l-orange-500 bg-orange-50/20';
                    aiBadge = `<div class="flex items-center gap-1 text-[10px] font-bold text-orange-600 bg-orange-100 px-2 py-0.5 rounded-full mb-2 w-fit"><i data-lucide="sparkles" class="w-3 h-3 animate-pulse"></i> SMART MATCH</div>`;
                }

                let primaryAction = '', secondaryActions = '';
                if(mode === 'browse') {
                    primaryAction = `<button onclick="sendConnect('${b.id}', this)" class="btn-primary text-xs w-full py-2">Connect +</button>`;
                    secondaryActions = `<button onclick="openReportModal('${b.id}', '${escapedName}')" class="text-[10px] text-gray-400 hover:text-red-500 flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i> Report</button>`;
                } else {
                    primaryAction = `<button onclick="openChat('${b.id}', '${escapedName}')" class="btn-primary text-xs w-full py-2">Chat Now</button>`;
                    secondaryActions = `
                        <button onclick="disconnectUser('${b.id}', '${escapedName}')" class="text-[10px] text-red-400 hover:text-red-600 flex items-center gap-1"><i data-lucide="user-x" class="w-3 h-3"></i> Disconnect</button>
                        <button onclick="openReportModal('${b.id}', '${escapedName}')" class="text-[10px] text-gray-400 hover:text-red-500 flex items-center gap-1"><i data-lucide="flag" class="w-3 h-3"></i> Report</button>
                    `;
                }

                list.innerHTML += `
                <div class="card p-5 hover:shadow-md transition bg-white border-l-4 ${cardClass}">
                    <div class="flex justify-between items-start gap-4">
                        <div class="min-w-0 flex-1">
                            ${aiBadge}
                            <h3 onclick="openProfileModal(${index}, ${isConnected})" class="font-bold text-lg text-gray-900 flex items-center leading-tight cursor-pointer hover:text-orange-600 transition-colors">
                                ${b.name}${verifiedBadge}${unreadDot}
                            </h3>
                            <p class="text-sm text-gray-500 flex items-start gap-1.5 mt-1"><i data-lucide="map-pin" class="w-4 h-4 mt-0.5 shrink-0 text-gray-400"></i><span>${b.loc}</span></p>
                            <div class="mt-3 flex items-center gap-2">
                                <span class="pill bg-gray-100 text-gray-600 text-[9px] uppercase font-bold tracking-widest px-2 py-0.5">${b.type}</span>
                                <button onclick="openProfileModal(${index}, ${isConnected})" class="text-[10px] font-semibold text-blue-600 hover:underline">View Full Profile</button>
                            </div>
                        </div>
                        <div class="shrink-0 w-32 flex flex-col items-center">${primaryAction}<div class="mt-3 flex flex-col items-center gap-2">${secondaryActions}</div></div>
                    </div>
                </div>`;
            });
            lucide.createIcons();
            checkNotifications();
        } catch(e) { list.innerHTML = `<p class="text-red-500 text-center py-10">${e.message}</p>`; }
    }

    function openProfileModal(index, isConnected) {
        const data = currentConnectResults[index];
        if(!data) return;
        document.getElementById('pd_name').innerText = data.name || 'Unknown';
        document.getElementById('pd_type').innerText = data.type || 'N/A';
        document.getElementById('pd_loc').innerText = data.loc || 'N/A';
        document.getElementById('pd_score').innerText = data.score || 'N/A';
        const vBox = document.getElementById('pd_verif_box'), vBadge = document.getElementById('pd_verified');
        if (data.is_verified) {
            vBox.classList.remove('hidden'); vBadge.classList.remove('hidden');
            document.getElementById('pd_reg_num').innerText = data.reg_num || 'Verified';
            document.getElementById('pd_tax_id').innerText = data.tax_id || 'Not Provided';
        } else { vBox.classList.add('hidden'); vBadge.classList.add('hidden'); }
        const chatBtn = document.getElementById('pd_chat_btn');
        if (isConnected) { chatBtn.classList.remove('hidden'); chatBtn.onclick = () => { closeProfileModal(); openChat(data.id, data.name); }; } else { chatBtn.classList.add('hidden'); }
        document.getElementById('profile_detail_modal').classList.remove('hidden');
        lucide.createIcons();
    }

    function closeProfileModal() { document.getElementById('profile_detail_modal').classList.add('hidden'); }

    async function loadAnalytics() {
        try {
            const data = await call('/api/v1/analytics/dashboard');
            const portal = document.getElementById('portal_content');
            portal.innerHTML = data.type === 'Retailer' ? `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="card p-6"><p class="text-xs font-bold text-gray-400">Total Revenue</p><p class="text-4xl font-bold mt-2">$${data.revenue.toLocaleString()}</p><div class="h-24 mt-4"><canvas id="revChart"></canvas></div></div>
                    <div class="card p-6 text-center"><p class="text-xs font-bold text-gray-400">Credit Score</p><h1 class="text-6xl font-bold mt-2">1.84</h1><span class="pill bg-green-100 text-green-700">Gold Tier</span></div>
                    <div class="card p-0 overflow-hidden"><div class="bg-gray-50 px-4 py-2 border-b font-bold text-xs">Top Products</div><table class="w-full text-xs divide-y" id="prodTable"></table></div>
                </div>` : `<div class="card p-20 text-center text-gray-400 italic">Portal View for ${data.type} loading...</div>`;
            
            if(data.type === 'Retailer' && data.top_products) {
                const tb = document.getElementById('prodTable');
                data.top_products.forEach(p => { tb.innerHTML += `<tr class="hover:bg-gray-50"><td class="px-4 py-2">${p.item}</td><td class="px-4 py-2 text-right font-bold">$${p.value}</td></tr>`; });
                new Chart(document.getElementById('revChart'), { type: 'line', data: { labels: data.chart_labels, datasets: [{ data: data.chart_values, borderColor: '#ea580c', fill: true, backgroundColor: 'rgba(234,88,12,0.05)', tension:0.4 }] }, options: { plugins: {legend: {display:false}}, scales: {x:{display:false},y:{display:false}}, maintainAspectRatio:false }});
            }
        } catch(e) {}
    }

    async function loadRequests() {
        const panel = document.getElementById('requests_panel');
        const list = document.getElementById('requests_list');
        panel.classList.toggle('hidden');
        try {
            const data = await call('/api/v1/connect?mode=requests');
            list.innerHTML = '';
            if(!data.results || data.results.length === 0) { document.getElementById('notif_badge').classList.add('hidden'); list.innerHTML = '<p class="text-xs text-gray-500">No requests.</p>'; return; }
            data.results.forEach(r => {
                list.innerHTML += `<div class="flex justify-between items-center bg-white p-3 rounded-lg border shadow-sm"><span class="font-bold text-sm">${r.name}</span><div class="flex gap-2"><button onclick="acceptRequest('${r.id}', this)" class="px-3 py-1 bg-green-600 text-white text-xs font-bold rounded">Accept</button><button onclick="declineRequest('${r.id}', this)" class="px-3 py-1 border border-red-200 text-red-600 text-xs font-bold rounded">Decline</button></div></div>`;
            });
        } catch(e) {}
    }

    async function acceptRequest(id, btn) { btn.innerText = "..."; await call('/api/v1/connect', 'POST', { action:'accept', connection_id: id }); loadConnectHub('connections'); }
    async function declineRequest(id, btn) { btn.innerText = "..."; await call('/api/v1/connect', 'POST', { action:'decline', connection_id: id }); btn.closest('.flex').remove(); checkNotifications(); }
    async function checkNotifications() { const data = await call('/api/v1/connect?mode=requests'); const b = document.getElementById('notif_badge'); if(data.results?.length > 0) { b.classList.remove('hidden'); b.innerText = data.results.length; } else { b.classList.add('hidden'); } }
    async function sendConnect(id, btn) { btn.innerText = "Sending..."; await call('/api/v1/connect', 'POST', { action:'request', target_id:id }); btn.innerText = "Sent"; btn.className = "pill bg-green-100 text-green-700 text-xs"; }
    async function disconnectUser(id, name) { if(confirm(`Disconnect from ${name}?`)) { await call('/api/v1/connect', 'POST', { action:'disconnect', target_id:id }); loadConnectHub('connections'); } }

    let currentChatPartner = null, chatInterval = null;
    async function openChat(id, name) {
        currentChatPartner = id; document.getElementById('chat_partner_name').innerText = name; document.getElementById('chat_modal').classList.remove('hidden');
        try { await call(`/api/v1/chat/read?partner_id=${id}`, 'POST'); } catch(e) {}
        loadMessages(); chatInterval = setInterval(loadMessages, 3000);
    }
    function closeChat() { document.getElementById('chat_modal').classList.add('hidden'); clearInterval(chatInterval); }
    async function loadMessages() {
        if(!currentChatPartner) return;
        const box = document.getElementById('chat_box'), data = await call(`/api/v1/chat?partner_id=${currentChatPartner}`);
        const atBottom = box.scrollHeight - box.scrollTop === box.clientHeight; box.innerHTML = '';
        data.messages.forEach(m => { const al = m.is_me ? "self-end bg-orange-600 text-white" : "self-start bg-gray-200 text-gray-800"; box.innerHTML += `<div class="flex flex-col ${m.is_me ? 'items-end' : 'items-start'}"><div class="px-4 py-2 rounded-2xl max-w-[80%] text-sm ${al}">${m.text}</div><span class="text-[9px] text-gray-400 mt-1">${m.time}</span></div>`; });
        if(atBottom) box.scrollTop = box.scrollHeight;
    }
    async function sendMessage() { const i = document.getElementById('chat_input'), t = i.value.trim(); if(!t) return; i.value = ''; await call('/api/v1/chat', 'POST', { partner_id:currentChatPartner, content:t }); loadMessages(); }
    document.getElementById('chat_input')?.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });

    let currentReportTarget = null;
    function openReportModal(id, name) { currentReportTarget = id; document.getElementById('report_modal').classList.remove('hidden'); }
    function closeReportModal() { document.getElementById('report_modal').classList.add('hidden'); }
    async function submitReport() {
        const c = document.getElementById('report_category').value, d = document.getElementById('report_details').value, b = document.getElementById('btn_submit_report');
        if(!d.trim()) return; b.disabled = true; b.innerText = "...";
        try { await call('/api/v1/report', 'POST', { target_id: currentReportTarget, category: c, details: d }); alert("Reported."); closeReportModal(); } catch(e) {} finally { b.disabled = false; b.innerText = "Submit"; }
    }

    async function loadVerification() {
        try {
            const data = await call('/api/v1/verification');
            if(data.reg_num) document.getElementById('v_reg_num').value = data.reg_num;
            if(data.tax_id) document.getElementById('v_tax_id').value = data.tax_id;
            const sc = document.getElementById('verif_status_card'), f = document.getElementById('verifForm'), eb = document.getElementById('btn_edit_verif');
            if (data.status === "NOT_SUBMITTED") { sc.classList.add('hidden'); f.classList.remove('hidden'); }
            else {
                f.classList.add('hidden'); sc.classList.remove('hidden'); eb.classList.remove('hidden');
                document.getElementById('verif_title').innerText = data.status;
                document.getElementById('verif_desc').innerText = data.status === 'APPROVED' ? "Fully verified." : "Under review.";
                const iconBox = document.getElementById('verif_icon_box'), icon = document.getElementById('verif_icon');
                if (data.status === 'APPROVED') { iconBox.className = "w-10 h-10 rounded-full bg-green-100 flex items-center justify-center"; icon.className = "w-5 h-5 text-green-600"; icon.setAttribute('data-lucide', 'check'); }
                else { iconBox.className = "w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center"; icon.className = "w-5 h-5 text-blue-600 animate-spin"; icon.setAttribute('data-lucide', 'loader-2'); }
            }
            lucide.createIcons();
        } catch(e) {}
    }
    function enableVerifEdit() { document.getElementById('verifForm').classList.remove('hidden'); document.getElementById('verif_status_card').classList.add('hidden'); }

    async function init() {
        lucide.createIcons();
        try {
            const me = await call('/api/v1/me');
            currentUserType = me?.user?.type || 'Retailer';
            currentVerifStatus = me?.user?.status || 'NOT_SUBMITTED';
            document.getElementById('welcomeName').innerText = me?.user?.name || 'User';
            document.getElementById('email').innerText = me?.user?.email || '—';
        } catch(e) { window.location.href = SIGNIN_PAGE; }
    }

    const allCountries = ["Afghanistan","Albania","Algeria","Andorra","Angola","Antigua and Barbuda","Argentina","Armenia","Australia","Austria","Azerbaijan","Bahamas","Bahrain","Bangladesh","Barbados","Belarus","Belgium","Belize","Benin","Bhutan","Bolivia","Bosnia and Herzegovina","Botswana","Brazil","Brunei","Bulgaria","Burkina Faso","Burundi","Cabo Verde","Cambodia","Cameroon","Canada","Central African Republic","Chad","Chile","China","Colombia","Comoros","Congo (DRC)","Congo (Republic)","Costa Rica","Cote d'Ivoire","Croatia","Cuba","Cyprus","Czech Republic","Denmark","Djibouti","Dominica","Dominican Republic","Ecuador","Egypt","El Salvador","Equatorial Guinea","Eritrea","Estonia","Eswatini","Ethiopia","Fiji","Finland","France","Gabon","Gambia","Georgia","Germany","Ghana","Greece","Grenada","Guatemala","Guinea","Guinea-Bissau","Guyana","Haiti","Honduras","Hungary","Iceland","India","Indonesia","Iran","Iraq","Ireland","Israel","Italy","Jamaica","Japan","Jordan","Kazakhstan","Kenya","Kiribati","Korea (North)","Korea (South)","Kosovo","Kuwait","Kyrgyzstan","Laos","Latvia","Lebanon","Lesotho","Liberia","Libya","Liechtenstein","Lithuania","Luxembourg","Madagascar","Malawi","Malaysia","Maldives","Mali","Malta","Marshall Islands","Mauritania","Mauritius","Mexico","Micronesia","Moldova","Monaco","Mongolia","Montenegro","Morocco","Mozambique","Myanmar","Namibia","Nauru","Nepal","Netherlands","New Zealand","Nicaragua","Niger","Nigeria","North Macedonia","Norway","Oman","Pakistan","Palau","Palestine","Panama","Papua New Guinea","Paraguay","Peru","Philippines","Poland","Portugal","Qatar","Romania","Russia","Rwanda","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Samoa","San Marino","Sao Tome and Principe","Saudi Arabia","Senegal","Serbia","Seychelles","Sierra Leone","Singapore","Slovakia","Slovenia","Solomon Islands","Somalia","South Africa","South Sudan","Spain","Sri Lanka","Sudan","Suriname","Sweden","Switzerland","Syria","Taiwan","Tajikistan","Tanzania","Thailand","Timor-Leste","Togo","Tonga","Trinidad and Tobago","Tunisia","Turkey","Turkmenistan","Tuvalu","Uganda","Ukraine","United Arab Emirates","United Kingdom","United States","Uruguay","Uzbekistan","Vanuatu","Vatican City","Venezuela","Vietnam","Yemen","Zambia","Zimbabwe"];
    function initCountries(id) { const s = document.getElementById(id); if(!s) return; allCountries.forEach(c => { const o = document.createElement('option'); o.value = c; o.innerText = c; s.appendChild(o); }); }
    
    document.addEventListener("DOMContentLoaded", () => {
        initCountries('v_biz_loc'); initCountries('filter_loc');
        const lb = document.getElementById("lang-btn"), lm = document.getElementById("lang-menu");
        lb?.addEventListener("click", (e) => { e.stopPropagation(); lm.classList.toggle("hidden"); });
        document.addEventListener("click", () => lm?.classList.add("hidden"));
    });

    document.getElementById('logoutBtn')?.addEventListener('click', () => { localStorage.removeItem('token'); window.location.href = SIGNIN_PAGE; });
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
